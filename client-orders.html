<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Shoe Pao — Your Orders</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body{font-family:'Poppins',Arial,sans-serif;background:#fff;margin:0;color:#222}
        .orders-container{max-width:1100px;margin:24px auto;padding:22px}
        .orders-header{margin-bottom:16px}
        .orders-header h1{font-size:1.8rem;margin:0}
        .orders-sub{color:#666;margin-top:8px}
        .orders-list{display:flex;flex-wrap:wrap;gap:24px}
        .order-card{background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(34,34,34,0.07);width:300px;display:flex;flex-direction:column;border:1px solid #eee}
        .order-status-box{background:#f5f5f5;border-radius:8px 8px 0 0;padding:12px 18px;display:flex;align-items:center;gap:12px}
        .order-status-icon{width:28px;height:28px}
        .order-card-img{width:100%;height:180px;object-fit:cover}
        .order-card-divider{height:1.5px;background:#eee;width:100%}
        .order-card-info-row{display:flex;justify-content:space-between;padding:12px 18px 0 18px}
        .order-card-code-row{padding:6px 18px 0 18px;color:#444}
        .order-card-btn-row{display:flex;gap:8px;padding:12px 18px 18px 18px}
        .order-card-btn{flex:1;padding:10px;border-radius:22px;border:none;cursor:pointer;font-weight:600}
        .view-btn{background:#222;color:#fff}
        .cancel-btn{background:#b71c1c;color:#fff}
        .refund-btn{background:#777;color:#fff}
        @media (max-width:760px){.orders-container{padding:12px}.order-card{width:100%}}
    </style>
</head>
<body>
    <!-- Navigation Bar (copied from profile.html) -->
    <nav class="homepage-header" style="position:sticky;top:0;z-index:100;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.04);padding:0 40px;display:flex;align-items:center;justify-content:space-between;height:72px;padding-left:46px;">
        <div style="display:flex;align-items:center;gap:24px;">
            <a href="home.html" style="display:flex;align-items:center;gap:30px;text-decoration:none;color:inherit;">
                <img src="IMAGE/SHOEPAOLOGO.png" alt="SHOEPAO Logo" style="height:42px;width:auto;cursor:pointer;">
                <span class="header-caption" style="font-size:1.18rem;font-weight:600;color:#b71c1c;cursor:pointer;">Shoe Pao Footwear</span>
            </a>
            <span class="header-link" onclick="goToProfile()">Profile</span>
            <span class="header-link" onclick="goToProductList()">Shop</span>
            <span class="header-link" onclick="goToOrders()">Orders</span>
            <span class="header-link" onclick="goToWishlist()">Wishlist</span>
            <span class="header-link" onclick="goToFAQ()">Policies</span>
        </div>
        <div style="display:flex;align-items:center;gap:18px;">
            <button class="header-icon-btn" onclick="toggleSearchBox()" style="background:none;border:none;padding:6px;display:flex;align-items:center;cursor:pointer;"><img src="IMAGE/SEARCHICON.png" class="header-icon" alt="Search" style="width:26px;height:26px;"></button>
            <button class="header-icon-btn" onclick="goToUserPage()" style="background:none;border:none;padding:6px;display:flex;align-items:center;cursor:pointer;"><img src="IMAGE/USERICON.png" class="header-icon" alt="User" style="width:26px;height:26px;"></button>
            <button class="header-icon-btn" onclick="goToCartPage()" style="background:none;border:none;padding:6px;display:flex;align-items:center;cursor:pointer;"><img src="IMAGE/CARTICON.png" class="header-icon" alt="Cart" style="width:26px;height:26px;"></button>
        </div>
        <div class="search-box" id="searchBox" style="display:none;position:absolute;top:72px;right:80px;background:#fff;border:1px solid #ccc;border-radius:8px;padding:8px 16px;z-index:101;">
            <input type="text" class="search-input" id="searchInput" placeholder="Search products..." onkeydown="searchKeyDown(event)" style="font-family:'Poppins',Arial,sans-serif;font-size:1rem;border:none;outline:none;width:220px;padding:6px 0;">
        </div>
    </nav>

    <main class="orders-container">
        <div class="orders-header">
            <h1>Orders</h1>
            <div class="orders-sub">Your recent orders and their status</div>
        </div>

        <div class="orders-list" id="ordersList">
            <!-- order cards rendered here -->
        </div>
    </main>

    <!-- Order Details Modal Overlay -->
    <div id="orderModalOverlay" style="display:none;position:fixed;inset:0;background:rgba(34,34,34,0.45);z-index:9999;align-items:center;justify-content:center;">
        <div id="orderModal" style="background:#fff;border-radius:18px;box-shadow:0 8px 32px rgba(34,34,34,0.18);padding:28px;min-width:520px;max-width:96vw;">
            <div style="display:flex;align-items:center;justify-content:space-between;">
                <div style="font-size:1.2rem;font-weight:700;">Order Details</div>
                <button onclick="closeOrderModal()" style="background:none;border:none;cursor:pointer;"><img src="IMAGE/X.png" alt="Close" style="width:22px;height:22px;"></button>
            </div>
            <div style="height:1px;background:#eee;margin:14px 0;"></div>
            <div style="display:flex;gap:18px;align-items:flex-start;">
                <div style="flex:1;">
                    <div id="orderModalId" style="font-weight:600;margin-bottom:6px;"></div>
                    <div id="orderModalCustomer" style="margin-bottom:6px;font-weight:600;"></div>
                    <div id="orderModalName" style="margin-bottom:6px;color:#444;"></div>
                    <div id="orderModalEst" style="margin-bottom:6px;color:#444;"></div>
                    <div id="orderModalPayment" style="margin-bottom:6px;color:#444;"></div>
                    <div id="orderModalAddress" style="margin-bottom:6px;"></div>
                    <!-- Revocation reasons (populated when an admin revokes a cancellation) -->
                    <div id="orderModalRevocation" style="display:none;margin-top:6px;color:#b71c1c;font-weight:600;"></div>
                </div>
                <img id="orderModalImg" src="" alt="Product" style="width:160px;height:110px;object-fit:cover;border-radius:8px;">
            </div>
            <div style="margin-top:12px;font-weight:600;">Items</div>
            <div id="orderModalItems" style="margin-top:8px;"></div>
            <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <div id="orderModalStatus" style="font-weight:600;margin-bottom:6px;"></div>
                    <div id="orderModalDelivery" style="color:#444;font-size:0.95rem;margin-top:6px;"></div>
                </div>
                <div id="orderModalTotal" style="font-weight:700;"></div>
            </div>
        </div>
    </div>
    
            <!-- Refund Confirmation Modal -->
            <div id="refundModalOverlay" style="display:none;position:fixed;inset:0;background:rgba(34,34,34,0.45);z-index:10001;align-items:center;justify-content:center;">
                <div style="background:#fff;border-radius:12px;padding:20px;max-width:640px;width:94%;box-shadow:0 12px 40px rgba(0,0,0,0.18);">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                        <div style="font-weight:700;font-size:1.05rem;">Can you give a reason for your refund?</div>
                        <button onclick="closeRefundModal()" style="background:none;border:none;cursor:pointer;"><img src="IMAGE/X.png" alt="Close" style="width:20px;height:20px;"></button>
                    </div>
                    <div style="margin-bottom:8px;color:#444;">You may upload an image as proof of the issue (optional). Please provide a short explanation to continue.</div>
                            <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:8px;">
                                <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="refundReasonDamaged" /> Damaged or defective</label>
                                <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="refundReasonMissingParts" /> Missing parts</label>
                                <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="refundReasonMismatch" /> Doesn't match description</label>
                                <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="refundReasonCounterfeit" /> Counterfeit</label>
                                <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="refundReasonLate" /> Late delivery</label>
                                <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="refundReasonOther" /> Other: <input id="refundReasonOtherText" type="text" placeholder="Specify other reason" style="margin-left:8px;flex:1;padding:8px;border:1px solid #ddd;border-radius:6px;" /></label>
                                <div style="display:flex;flex-direction:column;gap:8px;margin-top:6px;">
                                    <div id="refundUpload" style="width:100%;border:1px solid #eee;border-radius:12px;padding:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:#fff;min-height:48px;box-sizing:border-box;">
                                        <div id="refundUploadInner" style="text-align:center;color:#444;font-family:'Poppins',Arial,sans-serif;width:100%;">
                                            <img id="refundPreview" src="" alt="" style="max-width:100%;max-height:160px;display:none;border-radius:8px;margin-bottom:8px;object-fit:contain;" />
                                            <div id="refundUploadPlaceholder" style="font-size:0.98rem;color:#444;padding:6px 8px;">+ Upload Photo (optional)</div>
                                        </div>
                                    </div>
                                    <input id="refundProof" type="file" accept="image/*" style="display:none;" />
                                </div>
                            </div>
                    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
                        <button onclick="closeRefundModal()" style="background:#fff;border:1px solid #ccc;padding:8px 14px;border-radius:10px;cursor:pointer;">Cancel</button>
                        <button id="confirmRefundBtn" onclick="confirmRefund()" disabled style="background:#b71c1c;color:#fff;border:none;padding:8px 14px;border-radius:10px;cursor:pointer;">Submit Refund Request</button>
                    </div>
                </div>
            </div>
    
    <!-- Cancel Confirmation Modal -->
    <div id="cancelModalOverlay" style="display:none;position:fixed;inset:0;background:rgba(34,34,34,0.45);z-index:10000;align-items:center;justify-content:center;">
        <div style="background:#fff;border-radius:12px;padding:20px;max-width:560px;width:92%;box-shadow:0 12px 40px rgba(0,0,0,0.18);">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                <div style="font-weight:700;font-size:1.05rem;">Why are you cancelling this order?</div>
                <button onclick="closeCancelModal()" style="background:none;border:none;cursor:pointer;"><img src="IMAGE/X.png" alt="Close" style="width:20px;height:20px;"></button>
            </div>
            <div style="margin-bottom:8px;color:#444;">Select a reason (required). If you choose "Other" please provide details.</div>
            <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:8px;">
                <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="cancelReasonChange" /> Change of mind</label>
                <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="cancelReasonIncorrect" /> Incorrect Order</label>
                <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="cancelReasonOther" /> Other: <input id="cancelReasonOtherText" type="text" placeholder="Specify other reason" style="margin-left:8px;flex:1;padding:8px;border:1px solid #ddd;border-radius:6px;" /></label>
            </div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
                <button onclick="closeCancelModal()" style="background:#fff;border:1px solid #ccc;padding:8px 14px;border-radius:10px;cursor:pointer;">Back</button>
                <button id="confirmCancelBtn" onclick="confirmCancel()" disabled style="background:#b71c1c;color:#fff;border:none;padding:8px 14px;border-radius:10px;cursor:pointer;">Confirm Cancellation</button>
            </div>
        </div>
    </div>

    <script>
    // Render order cards from localStorage.cart (client-side orders page)
    (function(){
        function formatPHP(n){ return 'PHP ' + Number(n).toLocaleString(undefined,{minimumFractionDigits:0}); }
        function titleCase(str){
            if(!str && str !== 0) return '';
            return String(str).split(/(\s+)/).map(token=>{
                if(/\s+/.test(token)) return token;
                if(!/[a-zA-Z]/.test(token.charAt(0))) return token;
                return token.charAt(0).toUpperCase() + token.slice(1);
            }).join('');
        }

        // Render orders from localStorage.orders (client order history)
        function renderOrders(){
            const orders = JSON.parse(localStorage.getItem('orders')||'[]');
            const profile = JSON.parse(localStorage.getItem('profile')||'{}') || {};
            const container = document.getElementById('ordersList');
            container.innerHTML='';
            if(!orders || orders.length===0){ container.innerHTML='<div style="color:#666">You have no orders yet.</div>'; return; }

            // If a non-admin user is signed in, only show orders that belong to their email.
            let visibleOrders = orders;
            try{
                if(profile && profile.email && String((profile.role||'')).toLowerCase() !== 'admin'){
                    const email = (profile.email||'').toLowerCase();
                    visibleOrders = orders.filter(function(o){
                        const candidates = [o.email, o.customerEmail, o.checkoutEmail, o.customerName];
                        if(o.profile && o.profile.email) candidates.push(o.profile.email);
                        if(o.customer && o.customer.email) candidates.push(o.customer.email);
                        return candidates.some(c => (c||'').toLowerCase() === email);
                    });
                }
            }catch(e){ /* ignore filter errors and show all */ }

            if(!visibleOrders || visibleOrders.length === 0){ container.innerHTML='<div style="color:#666">You have no orders yet.</div>'; return; }

            visibleOrders.forEach((order, idx)=>{
                const itemCount = order.items.reduce((s,it)=>s + (it.quantity||it.qty||1), 0);
                const firstImage = (order.items[0] && (order.items[0].image || 'IMAGE/NIKE1.png'));
                // derive a short shipping snippet for card display
                var shortAddr = '';
                if(order.shippingAddress){
                    shortAddr = order.shippingAddress.replace(/\s+/g, ' ').trim();
                    if(shortAddr.length > 60) shortAddr = shortAddr.substring(0,57) + '...';
                } else if(order.shippingRegion){
                    shortAddr = order.shippingRegion;
                } else if(order.deliveryLabel){
                    shortAddr = order.deliveryLabel;
                }
                const card = document.createElement('div'); card.className='order-card';
                card.innerHTML = `
                    <div class="order-status-box">
                        <img src="IMAGE/PendingIcon.png" class="order-status-icon" alt="${titleCase(order.status)}">
                        <div style="display:flex;flex-direction:column;"><span style="font-weight:600">${titleCase(order.status)}</span><span style="font-size:0.92rem;color:#666">${titleCase(new Date(order.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }))}</span></div>
                    </div>
                    <img src="${firstImage}" class="order-card-img" alt="Order Image">
                    <div class="order-card-divider"></div>
                    <div class="order-card-info-row"><span>${itemCount} Item${itemCount>1?'s':''}</span><span style="font-weight:600">${formatPHP(order.total)}</span></div>
                    <div class="order-card-code-row">Order ${order.id}</div>
                    ${ shortAddr ? ('<div style="padding:6px 18px;color:#666;font-size:0.95rem;">Ship to: ' + shortAddr + '</div>') : '' }
                    ${ order.est ? ('<div style="padding:6px 18px;color:#444;font-size:0.95rem;font-weight:600;">Est. Delivery: ' + order.est + '</div>') : '' }
                        ${ (order.cancellation && order.cancellation.adminRevoked) ? ('<div style="padding:6px 18px;color:#b71c1c;font-weight:600;">Cancel Request Was Revoked</div>') : '' }
                        <div class="order-card-btn-row">
                        <button class="order-card-btn view-btn" onclick="openOrderModal(${idx})">View Order</button>
                        <button class="order-card-btn cancel-btn" onclick="requestCancelOrder(${idx})">Cancel</button>
                        <button class="order-card-btn refund-btn" onclick="requestRefundOrder(${idx})">Refund</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        window.renderOrders = renderOrders;

        window.addEventListener('DOMContentLoaded', renderOrders);
        // If URL has ?open=<orderId>, open that order modal by finding its index
        window.addEventListener('DOMContentLoaded', function(){
            try{
                var params = new URLSearchParams(window.location.search);
                var openId = params.get('open');
                if(openId){
                    var orders = JSON.parse(localStorage.getItem('orders')||'[]');
                    var idx = orders.findIndex(function(o){ return (o.id||'') === openId; });
                    if(idx !== -1){
                        // ensure render completed then open modal
                        setTimeout(function(){ openOrderModal(idx); }, 120);
                    }
                }
            }catch(e){/* ignore */}
        });

        // Listen for orders changes from other tabs/windows (so admin updates reflect here)
        window.addEventListener('storage', function(e){
            if(e.key === 'orders'){
                try{
                    renderOrders();
                    // If the order modal is open, refresh its contents for the same Order ID
                    var overlay = document.getElementById('orderModalOverlay');
                    if(overlay && overlay.style.display === 'flex'){
                        var currentIdText = (document.getElementById('orderModalId')||{}).textContent || '';
                        var m = currentIdText.match(/Order ID:\s*(\S+)/);
                        var currentId = m ? m[1] : null;
                        if(currentId){
                            var orders = JSON.parse(localStorage.getItem('orders') || '[]');
                            var idx = orders.findIndex(function(o){ return o.id === currentId; });
                            if(idx !== -1){
                                // reopen modal for this order index so updated est/payment show
                                openOrderModal(idx);
                            }
                        }
                    }
                }catch(err){/* ignore */}
            }
        });

        window.removeOrder = function(idx){
            var orders = JSON.parse(localStorage.getItem('orders')||'[]');
            if (!orders || !orders[idx]) return;
            orders.splice(idx,1);
            localStorage.setItem('orders', JSON.stringify(orders));
            renderOrders(); closeOrderModal();
        }

    // Cancellation flow: request explanation before marking cancelled
    var _pendingCancelIndex = null;
    // Refund flow
    var _pendingRefundIndex = null;
        // Expose these helpers on `window` so inline onclick handlers can call them
        window.requestCancelOrder = function(idx){
            _pendingCancelIndex = idx;
            // reset cancel modal inputs
            var chkChange = document.getElementById('cancelReasonChange'); if(chkChange) chkChange.checked = false;
            var chkIncorrect = document.getElementById('cancelReasonIncorrect'); if(chkIncorrect) chkIncorrect.checked = false;
            var chkOther = document.getElementById('cancelReasonOther'); if(chkOther) chkOther.checked = false;
            var otherText = document.getElementById('cancelReasonOtherText'); if(otherText) otherText.value = '';
            var btn = document.getElementById('confirmCancelBtn'); if(btn) btn.disabled = true;
            var overlay = document.getElementById('cancelModalOverlay');
            if(overlay) overlay.style.display = 'flex';
            setTimeout(function(){ var el = document.getElementById('cancelReasonOtherText'); if(el) el.focus(); }, 120);
        }

        window.closeCancelModal = function(){
            var overlay = document.getElementById('cancelModalOverlay');
            if(overlay) overlay.style.display = 'none';
            _pendingCancelIndex = null;
        }

        document.addEventListener('DOMContentLoaded', function(){
            // Cancel modal inputs
            var chkChange = document.getElementById('cancelReasonChange');
            var chkIncorrect = document.getElementById('cancelReasonIncorrect');
            var chkOther = document.getElementById('cancelReasonOther');
            var otherText = document.getElementById('cancelReasonOtherText');
            function updateCancelBtn(){
                var btn = document.getElementById('confirmCancelBtn');
                if(!btn) return;
                var anyChecked = (chkChange && chkChange.checked) || (chkIncorrect && chkIncorrect.checked) || (chkOther && chkOther.checked);
                if(!anyChecked){ btn.disabled = true; return; }
                if(chkOther && chkOther.checked){ btn.disabled = !(otherText && otherText.value && otherText.value.trim().length > 2); return; }
                btn.disabled = false;
            }
            if(chkChange) chkChange.addEventListener('change', updateCancelBtn);
            if(chkIncorrect) chkIncorrect.addEventListener('change', updateCancelBtn);
            if(chkOther) chkOther.addEventListener('change', updateCancelBtn);
            if(otherText) otherText.addEventListener('input', updateCancelBtn);
            // refund reason checkboxes and other text
            var chkDamaged = document.getElementById('refundReasonDamaged');
            var chkMissing = document.getElementById('refundReasonMissingParts');
            var chkMismatch = document.getElementById('refundReasonMismatch');
            var chkCounterfeit = document.getElementById('refundReasonCounterfeit');
            var chkLate = document.getElementById('refundReasonLate');
            var chkOther = document.getElementById('refundReasonOther');
            var otherText = document.getElementById('refundReasonOtherText');
            function updateRefundBtn(){
                var btn = document.getElementById('confirmRefundBtn'); if(!btn) return;
                var any = (chkDamaged && chkDamaged.checked) || (chkMissing && chkMissing.checked) || (chkMismatch && chkMismatch.checked) || (chkCounterfeit && chkCounterfeit.checked) || (chkLate && chkLate.checked) || (chkOther && chkOther.checked);
                if(!any){ btn.disabled = true; return; }
                if(chkOther && chkOther.checked){ btn.disabled = !(otherText && otherText.value && otherText.value.trim().length > 2); return; }
                btn.disabled = false;
            }
            [chkDamaged, chkMissing, chkMismatch, chkCounterfeit, chkLate, chkOther].forEach(function(e){ if(e) e.addEventListener('change', updateRefundBtn); });
            if(otherText) otherText.addEventListener('input', updateRefundBtn);
            // Setup refund upload click / preview behavior
            var refundUpload = document.getElementById('refundUpload');
            var refundInput = document.getElementById('refundProof');
            var refundPreview = document.getElementById('refundPreview');
            var refundPlaceholder = document.getElementById('refundUploadPlaceholder');
            if(refundUpload && refundInput){
                refundUpload.addEventListener('click', function(){ refundInput.click(); });
                refundInput.addEventListener('change', function(e){
                    var file = (refundInput.files && refundInput.files[0]) || null;
                    if(!file){ refundPreview.style.display = 'none'; refundPlaceholder.style.display = 'block'; return; }
                    if(file.type && file.type.indexOf('image') === 0){
                        var reader = new FileReader();
                        reader.onload = function(ev){
                            refundPreview.src = ev.target.result;
                            refundPreview.style.display = 'block';
                            refundPlaceholder.style.display = 'none';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        // not image: just show filename
                        refundPreview.style.display = 'none';
                        refundPlaceholder.textContent = file.name || 'Selected file';
                    }
                });
            }
        });

        window.confirmCancel = function(){
            // gather selected reasons
            var chkChange = document.getElementById('cancelReasonChange');
            var chkIncorrect = document.getElementById('cancelReasonIncorrect');
            var chkOther = document.getElementById('cancelReasonOther');
            var otherText = document.getElementById('cancelReasonOtherText');
            var selections = [];
            if(chkChange && chkChange.checked) selections.push('Change of mind');
            if(chkIncorrect && chkIncorrect.checked) selections.push('Incorrect Order');
            if(chkOther && chkOther.checked && otherText && otherText.value && otherText.value.trim()) selections.push(otherText.value.trim());
            if(selections.length === 0) return; // require at least one reason (sanity)
            var orders = JSON.parse(localStorage.getItem('orders')||'[]');
            var idx = _pendingCancelIndex;
            if(!orders || !orders[idx]){
                window.closeCancelModal && window.closeCancelModal();
                return;
            }
            // mark order as cancellation requested and store reason
            var order = orders[idx];
            // store previous status so admin can revoke
            order.previousStatus = order.status || 'Pending';
            order.status = 'Cancel Requested';
            order.cancellation = {
                reasons: selections,
                timestamp: new Date().toISOString(),
                clientConfirmed: true
            };
            orders[idx] = order;
            localStorage.setItem('orders', JSON.stringify(orders));
            window.closeCancelModal && window.closeCancelModal();
            renderOrders();
            // If order modal is open for this order, close it
            try{ var overlay = document.getElementById('orderModalOverlay'); if(overlay && overlay.style.display==='flex'){ closeOrderModal(); } }catch(e){}
        }

        // Refund modal helpers
        window.requestRefundOrder = function(idx){
            _pendingRefundIndex = idx;
            var proofEl = document.getElementById('refundProof'); if(proofEl) proofEl.value = '';
            var ta = document.getElementById('refundReason'); if(ta) ta.value = '';
            var btn = document.getElementById('confirmRefundBtn'); if(btn) btn.disabled = true;
            var overlay = document.getElementById('refundModalOverlay'); if(overlay) overlay.style.display = 'flex';
            setTimeout(function(){ var el = document.getElementById('refundReason'); if(el) el.focus(); }, 120);
        }

        window.closeRefundModal = function(){
            var overlay = document.getElementById('refundModalOverlay'); if(overlay) overlay.style.display = 'none';
            _pendingRefundIndex = null;
        }

        window.confirmRefund = function(){
            // gather selected reasons
            var chkDamaged = document.getElementById('refundReasonDamaged');
            var chkMissing = document.getElementById('refundReasonMissingParts');
            var chkMismatch = document.getElementById('refundReasonMismatch');
            var chkCounterfeit = document.getElementById('refundReasonCounterfeit');
            var chkLate = document.getElementById('refundReasonLate');
            var chkOther = document.getElementById('refundReasonOther');
            var otherText = document.getElementById('refundReasonOtherText');
            var selections = [];
            if(chkDamaged && chkDamaged.checked) selections.push('Damaged or defective');
            if(chkMissing && chkMissing.checked) selections.push('Missing parts');
            if(chkMismatch && chkMismatch.checked) selections.push("Doesn't match description");
            if(chkCounterfeit && chkCounterfeit.checked) selections.push('Counterfeit');
            if(chkLate && chkLate.checked) selections.push('Late delivery');
            if(chkOther && chkOther.checked && otherText && otherText.value && otherText.value.trim()) selections.push(otherText.value.trim());
            if(selections.length === 0) return; // require at least one reason

            var orders = JSON.parse(localStorage.getItem('orders')||'[]');
            var idx = _pendingRefundIndex;
            if(!orders || !orders[idx]){
                window.closeRefundModal && window.closeRefundModal();
                return;
            }
            var order = orders[idx];
            // store previous status so admin can revoke
            order.previousStatus = order.status || 'Pending';
            order.status = 'Refund Requested';
            order.refund = {
                reasons: selections,
                timestamp: new Date().toISOString(),
                clientConfirmed: true
            };

            // if file attached, read it as data URL and persist inside order.refund
            var proofInput = document.getElementById('refundProof');
            var file = (proofInput && proofInput.files && proofInput.files[0]) ? proofInput.files[0] : null;
            function persistOrderWithProof(dataUrl, fileName){
                if(dataUrl){ order.refund.proof = dataUrl; order.refund.proofName = fileName || '' }
                orders[idx] = order;
                localStorage.setItem('orders', JSON.stringify(orders));
                window.closeRefundModal && window.closeRefundModal();
                renderOrders();
                try{ var overlay = document.getElementById('orderModalOverlay'); if(overlay && overlay.style.display==='flex'){ closeOrderModal(); } }catch(e){}
            }
            if(file){
                var reader = new FileReader();
                reader.onload = function(ev){ try{ persistOrderWithProof(ev.target.result, file.name); }catch(e){ persistOrderWithProof(null); } };
                reader.readAsDataURL(file);
            } else {
                persistOrderWithProof(null);
            }
        }

        window.openOrderModal = function(idx){
            var orders = JSON.parse(localStorage.getItem('orders')||'[]');
            var order = orders[idx];
            if(!order) return;
            document.getElementById('orderModalId').textContent = 'Order ID: ' + order.id;
            // customer name (fall back to saved profile or checkout if order doesn't include it)
            var customerName = order.customerName || (JSON.parse(localStorage.getItem('profile')||'{}').name) || localStorage.getItem('checkoutCustomerName') || '';
            document.getElementById('orderModalCustomer').textContent = customerName ? ('Customer: ' + customerName) : '';
            document.getElementById('orderModalName').textContent = 'Order Date: ' + new Date(order.date).toLocaleString();
            // Est. Delivery (order.est may be a human string stored by admin)
            document.getElementById('orderModalEst').textContent = order.est ? ('Est. Delivery: ' + order.est) : '';
            // show payment method and tracking separately
            // Payment: prefer paymentLabel, fall back to payment or mapping from code
            var paymentLabel = order.paymentLabel || order.payment || '';
            if(!paymentLabel && order.paymentCode){
                if(order.paymentCode === 'qr_ph') paymentLabel = 'QR PH';
                else if(order.paymentCode === 'bank_transfer') paymentLabel = 'Bank Transfer';
                else if(order.paymentCode === 'cod') paymentLabel = 'Cash on Delivery';
            }
            document.getElementById('orderModalPayment').textContent = paymentLabel ? ('Payment: ' + paymentLabel) : '';
            // show shipping address (if present) and tracking number
            var addrTxt = '';
            if(order.shippingAddress){ addrTxt += 'Ship to: ' + order.shippingAddress; }
            if(order.shippingRegion){ addrTxt += (addrTxt ? ' — ' : '') + 'Region: ' + order.shippingRegion; }
            if(order.tracking){ addrTxt += (addrTxt ? '\n' : '') + 'Tracking #: ' + order.tracking; }
            document.getElementById('orderModalAddress').textContent = addrTxt;
            // delivery method: prefer deliveryLabel, fall back to deliveryMethod or checkout value
            var deliveryLabel = order.deliveryLabel || order.deliveryMethod || localStorage.getItem('checkoutDelivery') || '';
            if(!deliveryLabel && order.deliveryCode){
                if(order.deliveryCode === 'personal') deliveryLabel = 'Personal Delivery';
                else if(order.deliveryCode === 'lalamove') deliveryLabel = 'Lalamove';
                else if(order.deliveryCode === 'jnt') deliveryLabel = 'J&T Express';
            }
            document.getElementById('orderModalDelivery').textContent = deliveryLabel ? ('Delivery: ' + deliveryLabel) : '';
            document.getElementById('orderModalImg').src = (order.items[0] && order.items[0].image) || 'IMAGE/NIKE1.png';
            // items list
            var itemsHtml = '';
            order.items.forEach(function(it){
                var qty = it.quantity || it.qty || 1;
                itemsHtml += '<div style="margin-bottom:6px;">' + qty + ' x ' + (it.title||'Product') + ' — ' + formatPHP((it.price||0) * qty) + '</div>';
            });
            document.getElementById('orderModalItems').innerHTML = itemsHtml;
            document.getElementById('orderModalStatus').textContent = 'Status: ' + titleCase(order.status);
            // show shipping (if present) and total
            var ship = Number(order.shipping || 0);
            if(ship && ship > 0){
                var shipLine = '<div style="margin-top:8px;color:#444;">Shipping: ' + formatPHP(ship) + '</div>';
                document.getElementById('orderModalItems').insertAdjacentHTML('beforeend', shipLine);
            }
            document.getElementById('orderModalTotal').textContent = formatPHP(order.total || (order.subtotal + (order.shipping||0)));
            // Show admin revocation reasons if admin revoked a cancellation
            try{
                var revDiv = document.getElementById('orderModalRevocation');
                if(revDiv){
                    if(order.cancellation && order.cancellation.adminRevoked){
                        var rev = order.cancellation.revocation || order.cancellation.revocation || {};
                        var reasons = (rev.reasons && rev.reasons.length) ? rev.reasons : (order.cancellation.reasons || []);
                        var ts = rev.timestamp || order.cancellation.revocation && order.cancellation.revocation.timestamp || '';
                        var html = '<div style="font-weight:700;color:#b71c1c;margin-top:6px;">Cancel Request Was Revoked</div>';
                        if(reasons && reasons.length){
                            html += '<div style="color:#444;font-weight:600;margin-top:6px;">Reason(s):</div><ul style="margin:6px 0 0 18px;color:#444;">';
                            reasons.forEach(function(r){ html += '<li>' + (r || '') + '</li>'; });
                            html += '</ul>';
                        }
                        if(ts){
                            try{ html += '<div style="margin-top:6px;color:#666;font-size:0.9rem;">Revoked on: ' + new Date(ts).toLocaleString() + '</div>'; }catch(e){ html += '<div style="margin-top:6px;color:#666;font-size:0.9rem;">Revoked on: ' + ts + '</div>'; }
                        }
                        revDiv.innerHTML = html; revDiv.style.display = 'block';
                    } else {
                        revDiv.innerHTML = ''; revDiv.style.display = 'none';
                    }
                }
            }catch(e){ /* ignore if modal missing */ }
            document.getElementById('orderModalOverlay').style.display = 'flex'; document.body.style.overflow='hidden';
        }

        window.closeOrderModal = function(){ document.getElementById('orderModalOverlay').style.display = 'none'; document.body.style.overflow=''; }
    })();
    </script>

    <script>
    // Navigation bar functions (from profile.html) to match profile header behavior
    function goToHome() { window.location.href = 'home.html'; }
    function goToProfile() { window.location.href = 'profile.html'; }
    function goToProductList() { window.location.href = 'product-list.html'; }
    function goToOrders() { window.location.href = 'client-orders.html'; }
    function goToWishlist() { window.location.href = 'wishlist.html'; }
    function goToFAQ() { window.location.href = 'policy.html'; }
    function goToContact() { window.location.href = 'contact.html'; }
    function goToUserPage() { window.location.href = 'profile.html'; }
    function goToCartPage() { window.location.href = 'cart.html'; }
    function toggleSearchBox() {
        var box = document.getElementById('searchBox');
        box.style.display = (box.style.display === 'block') ? 'none' : 'block';
        if (box.style.display === 'block') {
            document.getElementById('searchInput').focus();
        }
    }
    function searchKeyDown(e) {
        if (e.key === 'Enter') {
            var val = document.getElementById('searchInput').value.trim();
            if (val) {
                window.location.href = 'product-list.html?search=' + encodeURIComponent(val);
            }
        }
    }
    </script>

    <!-- ===== ADDED: Cart Overlay + Sidebar HTML (from product-list.html) ===== -->
    <div id="cartOverlay" class="cart-overlay" aria-hidden="true"></div>
    <aside id="cartSidebar" class="cart-sidebar" aria-hidden="true" role="complementary">
        <div class="cart-header-row">
            <div>
                <span class="cart-header-title">Cart (<span id="cartCount">0</span>)</span>
            </div>
            <button id="closeCartBtn" class="cart-close" aria-label="Close cart"><img src="IMAGE/X.png" alt="Close" style="width:20px;height:20px;"></button>
        </div>
        <div class="cart-divider"></div>
        <div id="cartItems" class="cart-items">
            <div class="cart-empty">Your cart is empty</div>
        </div>
        <div class="cart-divider"></div>
        <div class="cart-subtotal-row">
            <span class="cart-subtotal-label">Subtotal</span>
            <span id="cartSubtotal" class="cart-subtotal-value">₱0.00</span>
        </div>
        <button id="checkoutBtn" class="cart-checkout-btn">Checkout</button>
    </aside>
    <!-- ===== ADDED: Cart Sidebar Behavior (from product-list.html) ===== -->
    <script>
    (function(){
        // cart data structure
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        // helpers
        function parsePriceToNumber(priceText) {
            if (!priceText) return 0;
            var v = priceText.replace(/[^0-9.]/g, '');
            return parseFloat(v || 0);
        }
        function formatPHP(amount) {
            try {
                return new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(amount);
            } catch (e) {
                return '₱' + Number(amount).toFixed(2);
            }
        }
        function saveCartToLocalStorage() {
            localStorage.setItem('cart', JSON.stringify(cart));
        }
        // DOM refs
        const cartOverlay = document.getElementById('cartOverlay');
        const cartSidebar = document.getElementById('cartSidebar');
        const cartItemsContainer = document.getElementById('cartItems');
        const cartCountEl = document.getElementById('cartCount');
        const cartSubtotalEl = document.getElementById('cartSubtotal');
        const closeCartBtn = document.getElementById('closeCartBtn');
        const checkoutBtn = document.getElementById('checkoutBtn');
        // find nav cart button (the one with image alt="Cart")
        function getNavCartButton() {
            const img = document.querySelector('img[alt="Cart"]');
            if (!img) return null;
            return img.closest('button');
        }
        function openCartSidebar() {
            cartOverlay.classList.add('show');
            cartSidebar.classList.add('open');
            document.body.style.overflow = 'hidden';
            cartSidebar.setAttribute('aria-hidden', 'false');
            cartOverlay.setAttribute('aria-hidden', 'false');
        }
        function closeCartSidebar() {
            cartOverlay.classList.remove('show');
            cartSidebar.classList.remove('open');
            document.body.style.overflow = '';
            cartSidebar.setAttribute('aria-hidden', 'true');
            cartOverlay.setAttribute('aria-hidden', 'true');
        }
        function renderCart() {
            cartItemsContainer.innerHTML = '';
            if (cart.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'cart-empty';
                empty.textContent = 'Your cart is empty';
                cartItemsContainer.appendChild(empty);
                cartCountEl.textContent = 0;
                cartSubtotalEl.textContent = formatPHP(0);
                saveCartToLocalStorage();
                return;
            }
            let subtotal = 0;
            let totalQty = 0;
            cart.forEach((item, index) => {
                const qty = (typeof item.qty === 'number') ? item.qty : (typeof item.quantity === 'number' ? item.quantity : 1);
                subtotal += item.price * qty;
                totalQty += qty;
                const box = document.createElement('div');
                box.className = 'cart-item-box';
                const img = document.createElement('img');
                img.className = 'cart-item-img';
                img.src = item.image || 'IMAGE/NIKE1.png';
                img.alt = item.title || 'Product';
                const middle = document.createElement('div');
                middle.className = 'cart-item-middle';
                const title = document.createElement('div');
                title.className = 'cart-item-title';
                title.textContent = item.title;
                const brand = document.createElement('div');
                brand.className = 'cart-item-brand';
                brand.textContent = item.brand;
                const size = document.createElement('div');
                size.className = 'cart-item-size';
                size.textContent = 'Size: ' + (item.size || '');
                const qtyControls = document.createElement('div');
                qtyControls.className = 'cart-quantity-controls';
                const lessenBtn = document.createElement('button');
                lessenBtn.className = 'qty-btn decrease';
                lessenBtn.setAttribute('data-index', index);
                const lessenImg = document.createElement('img');
                lessenImg.src = 'IMAGE/LessenBTN.png';
                lessenImg.alt = '-';
                lessenImg.style.width = '22px';
                lessenImg.style.height = '22px';
                lessenBtn.appendChild(lessenImg);
                const qtyText = document.createElement('span');
                qtyText.className = 'cart-item-qty';
                qtyText.textContent = qty;
                const addBtn = document.createElement('button');
                addBtn.className = 'qty-btn increase';
                addBtn.setAttribute('data-index', index);
                const addImg = document.createElement('img');
                addImg.src = 'IMAGE/AddBTN.png';
                addImg.alt = '+';
                addImg.style.width = '22px';
                addImg.style.height = '22px';
                addBtn.appendChild(addImg);
                qtyControls.appendChild(lessenBtn);
                qtyControls.appendChild(qtyText);
                qtyControls.appendChild(addBtn);
                middle.appendChild(title);
                middle.appendChild(brand);
                middle.appendChild(size);
                middle.appendChild(qtyControls);
                const removeBtn = document.createElement('button');
                removeBtn.className = 'cart-item-remove';
                removeBtn.setAttribute('data-index', index);
                const trashImg = document.createElement('img');
                trashImg.src = 'IMAGE/TrashIcon.png';
                trashImg.alt = 'Remove';
                trashImg.style.width = '18px';
                trashImg.style.height = '18px';
                removeBtn.appendChild(trashImg);
                const priceEl = document.createElement('div');
                priceEl.className = 'cart-item-price';
                priceEl.textContent = formatPHP(item.price * qty);
                box.appendChild(img);
                box.appendChild(middle);
                box.appendChild(removeBtn);
                box.appendChild(priceEl);
                cartItemsContainer.appendChild(box);
            });
            cartCountEl.textContent = totalQty;
            cartSubtotalEl.textContent = formatPHP(subtotal);
            attachCartEvents();
        }
        function attachCartEvents() {
            // decrease
            document.querySelectorAll('.qty-btn.decrease').forEach(btn => {
                btn.onclick = function(e) {
                    const idx = parseInt(btn.getAttribute('data-index'), 10);
                    if (!isNaN(idx) && cart[idx]) {
                        // Use qty if present, else quantity
                        if (typeof cart[idx].qty === 'number') {
                            if (cart[idx].qty > 1) {
                                cart[idx].qty--;
                            }
                        } else if (typeof cart[idx].quantity === 'number') {
                            if (cart[idx].quantity > 1) {
                                cart[idx].quantity--;
                            }
                        }
                        renderCart();
                        saveCartToLocalStorage();
                    }
                };
            });
            // increase
            document.querySelectorAll('.qty-btn.increase').forEach(btn => {
                btn.onclick = function(e) {
                    const idx = parseInt(btn.getAttribute('data-index'), 10);
                    if (!isNaN(idx) && cart[idx]) {
                        if (typeof cart[idx].qty === 'number') {
                            cart[idx].qty++;
                        } else if (typeof cart[idx].quantity === 'number') {
                            cart[idx].quantity++;
                        }
                        renderCart();
                        saveCartToLocalStorage();
                    }
                };
            });
            // remove
            document.querySelectorAll('.cart-item-remove').forEach(btn => {
                btn.onclick = function(e) {
                    const idx = parseInt(btn.getAttribute('data-index'), 10);
                    if (!isNaN(idx)) {
                        cart.splice(idx, 1);
                        renderCart();
                        saveCartToLocalStorage();
                    }
                };
            });
        }
        // Hook nav cart button (remove its inline navigation and replace with open sidebar)
        document.addEventListener('DOMContentLoaded', function() {
            const navCartBtn = getNavCartButton();
            if (navCartBtn) {
                navCartBtn.removeAttribute('onclick');
                navCartBtn.addEventListener('click', function(e){
                    e.preventDefault();
                    openCartSidebar();
                });
            }
            // hook close buttons and overlay
            if (closeCartBtn) closeCartBtn.addEventListener('click', closeCartSidebar);
            if (cartOverlay) cartOverlay.addEventListener('click', closeCartSidebar);
            renderCart();
            if (checkoutBtn) {
                checkoutBtn.addEventListener('click', function(){
                    window.location.href = 'checkout.html';
                });
            }
        });
    })();
    </script>
    <script src="cart-storage.js"></script>

</body>
</html>
