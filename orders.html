<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders - SHOEPAO</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body.orders-body {
            font-family: 'Poppins', Arial, sans-serif;
            background: #fff;
            margin: 0;
            padding: 0;
            color: #222;
        }
        .orders-navbar {
            width: 100vw;
            background: #fff;
            box-shadow: 0 1px 0 #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 44px;
            height: 72px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .orders-navbar-left {
            display: flex;
            align-items: center;
            gap: 38px;
        }
        .orders-navbar-logo {
            height: 38px;
            width: auto;
            cursor: pointer;
        }
        .orders-navbar-link {
            font-size: 1.08rem;
            font-weight: 500;
            color: #222;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.15s;
        }
        .orders-navbar-link:hover {
            color: #b71c1c;
        }
        .orders-navbar-right {
            display: flex;
            align-items: center;
            gap: 18px;
        }
        .orders-header {
            font-size: 2rem;
            font-weight: 600;
            margin: 48px 0 24px 120px;
            font-family: 'Poppins', Arial, sans-serif;
        }
        .orders-list {
            display: flex;
            flex-wrap: wrap;
            gap: 32px;
            margin-left: 120px;
            margin-bottom: 180px;
        }
        .order-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(34,34,34,0.07);
            width: 300px;
            min-width: 300px;
            max-width: 340px;
            margin-bottom: 0;
            padding: 0 0 18px 0;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            border: 1px solid #eee;
        }
        .order-status-box {
            background: #f5f5f5;
            border-radius: 8px 8px 0 0;
            padding: 12px 18px 10px 18px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .order-status-icon {
            width: 28px;
            height: 28px;
        }
        .order-status-info {
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        .order-status-label {
            font-size: 1.01rem;
            font-weight: 500;
            color: #222;
        }
        .order-status-date {
            font-size: 0.93rem;
            color: #666;
            margin-top: 1px;
        }
        .order-card-img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 0 0 0 0;
            margin-bottom: 0;
        }
        .order-card-divider {
            width: 100%;
            height: 1.5px;
            background: #eee;
            margin: 0 0 0 0;
        }
        .order-card-info-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 18px 0 18px;
            font-size: 1.01rem;
        }
        .order-card-qty {
            color: #444;
        }
        .order-card-price {
            font-weight: 600;
            color: #222;
        }
        .order-card-code-row {
            padding: 4px 18px 0 18px;
            font-size: 0.97rem;
            color: #444;
        }
        .order-card-btn-row {
            display: flex;
            justify-content: center;
            margin-top: 16px;
        }
        .order-card-btn {
            background: #8B0000;
            color: #fff;
            border: none;
            border-radius: 22px;
            padding: 10px 0;
            width: 90%;
            font-size: 0.93rem;
            font-family: 'Poppins', Arial, sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(34,34,34,0.10);
        }
        .order-card-btn:hover {
            background: #5a0000;
        }
        @media (max-width: 900px) {
            .orders-header, .orders-list {
                margin-left: 12px;
            }
            .orders-list {
                gap: 18px;
                flex-direction: column;
                flex-wrap: nowrap;
            }
        }
        .cart-items {
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            max-height: 340px;
            padding-right: 8px;
        }
    </style>
</head>
<body>
    <header class="topbar">
        <div class="nav-left">
            <div class="nav-left-inner">
                <a class="logo-wrap" href="dashboard.html" aria-label="Shoe Pao dashboard">
                    <img src="IMAGE/SHOEPAOLOGO.png" alt="ShoePao logo">
                    <span class="site-title">Shoe Pao Footwear</span>
                </a>
                <a class="nav-item" href="dashboard.html">OVERVIEW</a>
                <a class="nav-item" href="orders.html">Orders</a>
                <a class="nav-item" href="inventory.html">Inventory</a>
                <a class="nav-item" href="accounts.html">Accounts</a>
            </div>
        </div>
        <div class="nav-right">
            <button class="profile-btn" onclick="location.href='profile.html'" aria-label="Profile">
                <img src="IMAGE/USERICON.png" alt="User">
            </button>
        </div>
    </header>
    <div class="site-container">
    <div class="orders-page">
        <div class="orders-header" style="padding:24px 120px 8px 120px;">
            <h1 style="margin:0;font-size:2rem;font-weight:700;">Orders</h1>
            <div style="color:#666;margin-top:6px;font-size:0.98rem;font-weight:400;">Manage Your Transactions</div>
        </div>

        <div style="height:18px;"></div>
        <div style="width:calc(100% - 240px);margin:0 120px 24px 120px;">
            <div style="height:1px;background:#eee;margin-bottom:18px;border-radius:2px;"></div>

            <div class="orders-table-card" style="background:#fff;border:1px solid #eee;border-radius:12px;padding:18px;">
                <div class="table-top-row" style="display:flex;align-items:center;gap:16px;margin-bottom:12px;flex-wrap:wrap;">
                    <input id="ordersSearch" type="search" placeholder="Search" style="flex:1 1 360px;padding:10px 14px;border:1px solid #e6e6e6;border-radius:8px;font-family:'Poppins',Arial,sans-serif;">

                    <div style="display:flex;gap:10px;margin-left:auto;flex-wrap:wrap;">
                        <button class="filter-btn" data-sort="date" style="display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:18px;border:1px solid #ddd;background:#fff;cursor:pointer;"><img src="IMAGE/Date.png" alt="Date" style="width:18px;height:18px"> Date</button>
                        <button class="filter-btn" data-sort="payment" style="display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:18px;border:1px solid #ddd;background:#fff;cursor:pointer;"><img src="IMAGE/Pay.png" alt="Pay" style="width:18px;height:18px"> Payment Method</button>
                        <button class="filter-btn" data-sort="id" style="display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:18px;border:1px solid #ddd;background:#fff;cursor:pointer;"><img src="IMAGE/USERICON.png" alt="ID" style="width:18px;height:18px"> Order ID</button>
                        <button class="filter-btn" data-sort="status" style="display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:18px;border:1px solid #ddd;background:#fff;cursor:pointer;"><img src="IMAGE/CheckIcon.png" alt="Status" style="width:18px;height:18px"> Status</button>
                    </div>
                </div>

                <div style="overflow:auto;">
                    <table id="ordersTable" style="width:100%;border-collapse:collapse;font-family:'Poppins',Arial,sans-serif;">
                        <thead>
                            <tr style="text-align:left;color:#444;border-bottom:1px solid #eee;">
                                            <th style="padding:14px 12px;min-width:60px;">No.</th>
                                            <th style="padding:14px 12px;min-width:140px;">Order ID</th>
                                <th style="padding:14px 12px;min-width:160px;">Customer Name</th>
                                <th style="padding:14px 12px;min-width:120px;">Date Ordered</th>
                                <th style="padding:14px 12px;min-width:140px;">Payment Method</th>
                                <th style="padding:14px 12px;min-width:140px;">Delivery Method</th>
                                <th style="padding:14px 12px;min-width:100px;">Total</th>
                                <th style="padding:14px 12px;min-width:100px;">Status</th>
                                <th style="padding:14px 12px;min-width:140px;">Est. Delivery</th>
                                <th style="padding:14px 12px;min-width:160px;">Tracking #</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTbody">
                            <!-- rows inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cancellation Review Modal (admin) -->
    <div id="cancelReviewModalOverlay" style="display:none;position:fixed;inset:0;background:rgba(34,34,34,0.45);z-index:100000;align-items:center;justify-content:center;">
        <div style="background:#fff;border-radius:12px;padding:20px;max-width:640px;width:94%;box-shadow:0 12px 40px rgba(0,0,0,0.18);">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                <div style="font-weight:700;font-size:1.05rem;">Client Cancellation Review</div>
                <button id="closeCancelReviewBtn" style="background:none;border:none;cursor:pointer;"><img src="IMAGE/X.png" alt="Close" style="width:20px;height:20px;"></button>
            </div>
            <div id="cancelReviewContent" style="margin-bottom:12px;color:#444;"></div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
                <button id="cancelFooterCloseBtn" onclick="closeCancelReviewModal()" style="background:#fff;border:1px solid #ccc;padding:8px 14px;border-radius:10px;cursor:pointer;">Close</button>
                <button id="adminRevokeBtn" style="background:#fff;border:1px solid #b71c1c;padding:8px 14px;border-radius:10px;color:#b71c1c;cursor:pointer;">Revoke Cancellation</button>
                <button id="adminConfirmCancelBtn" style="background:#b71c1c;color:#fff;border:none;padding:8px 14px;border-radius:10px;cursor:pointer;">Confirm Cancellation</button>
            </div>
        </div>
    </div>
    </div>
    <!-- Refund Review Modal (admin) -->
    <div id="refundReviewModalOverlay" style="display:none;position:fixed;inset:0;background:rgba(34,34,34,0.45);z-index:100000;align-items:center;justify-content:center;">
        <div style="background:#fff;border-radius:12px;padding:20px;max-width:640px;width:94%;box-shadow:0 12px 40px rgba(0,0,0,0.18);">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                <div style="font-weight:700;font-size:1.05rem;">Client Refund Review</div>
            </div>
            <div id="refundReviewContent" style="margin-bottom:12px;color:#444;"></div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
                <button id="refundFooterCloseBtn" onclick="closeRefundReviewModal()" style="background:#fff;border:1px solid #ccc;padding:8px 14px;border-radius:10px;cursor:pointer;">Close</button>
                <button id="adminRevokeRefundBtn" style="background:#fff;border:1px solid #b71c1c;padding:8px 14px;border-radius:10px;color:#b71c1c;cursor:pointer;">Revoke Refund</button>
                <button id="adminConfirmRefundBtn" style="background:#b71c1c;color:#fff;border:none;padding:8px 14px;border-radius:10px;cursor:pointer;">Confirm Refund</button>
            </div>
        </div>
    </div>

    <!-- Admin Order Details Modal (matches client order pop-up format) -->
    <div id="adminOrderModalOverlay" style="display:none;position:fixed;inset:0;background:rgba(34,34,34,0.45);z-index:9999;align-items:center;justify-content:center;">
        <div id="adminOrderModal" style="background:#fff;border-radius:18px;box-shadow:0 8px 32px rgba(34,34,34,0.18);padding:28px;min-width:520px;max-width:96vw;">
            <div style="display:flex;align-items:center;justify-content:space-between;">
                <div style="font-size:1.2rem;font-weight:700;">Order Details</div>
                <button id="adminOrderModalClose" style="background:none;border:none;cursor:pointer;"><img src="IMAGE/X.png" alt="Close" style="width:22px;height:22px;"></button>
            </div>
            <div style="height:1px;background:#eee;margin:14px 0;"></div>
            <div style="display:flex;gap:18px;align-items:flex-start;">
                <div style="flex:1;">
                        <div id="adminOrderModalId" style="font-weight:600;margin-bottom:6px;"></div>
                        <div id="adminOrderModalName" style="margin-bottom:6px;"></div>
                        <div id="adminOrderModalContact" style="margin-bottom:6px;"></div>
                        <div id="adminOrderModalPayment" style="margin-bottom:6px;font-weight:600;"></div>
                        <div id="adminOrderModalDelivery" style="margin-bottom:6px;color:#444;"></div>
                </div>
                <img id="adminOrderModalImg" src="IMAGE/NIKE1.png" alt="Product" style="width:160px;height:110px;object-fit:cover;border-radius:8px;">
            </div>
            <div style="margin-top:12px;font-weight:600;">Items</div>
            <div id="adminOrderModalItems" style="margin-top:8px;"></div>
            <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;">
                <div id="adminOrderModalStatus" style="font-weight:600;"></div>
                <div id="adminOrderModalTotal" style="font-weight:700;"></div>
            </div>
        </div>
    </div>
    <!-- Footer removed for admin orders page to avoid showing the black/site footer -->

    <script>
    // Navigation bar functions
    function goToHome() { window.location.href = 'home.html'; }
    function goToProfile() {
    try{ var p = JSON.parse(sessionStorage.getItem('profile')||localStorage.getItem('profile')||'null'); if(!p || !p.email){ window.location.href = 'login.html'; return; } }catch(e){ window.location.href = 'login.html'; return; }
        window.location.href = 'profile.html';
    }
    function goToProductList() { window.location.href = 'product-list.html'; }
    function goToOrders() { window.location.href = 'orders.html'; }
    function goToWishlist() { window.location.href = 'wishlist.html'; }
    function goToFAQ() { window.location.href = 'policy.html'; }
    function goToContact() { window.location.href = 'contact.html'; }
    function goToUserPage() {
    try{ var p = JSON.parse(sessionStorage.getItem('profile')||localStorage.getItem('profile')||'null'); if(!p || !p.email){ window.location.href = 'login.html'; return; } }catch(e){ window.location.href = 'login.html'; return; }
        window.location.href = 'profile.html';
    }
    function goToCartPage() { window.location.href = 'cart.html'; }
    function toggleSearchBox() {
        var box = document.getElementById('searchBox');
        box.style.display = (box.style.display === 'block') ? 'none' : 'block';
        if (box.style.display === 'block') {
            document.getElementById('searchInput').focus();
        }
    }
    function searchKeyDown(e) {
        if (e.key === 'Enter') {
            var val = document.getElementById('searchInput').value.trim();
            if (val) {
                window.location.href = 'product-list.html?search=' + encodeURIComponent(val);
            }
        }
    }
    // Orders table data + rendering, search and sort
    (function(){
        const year = new Date().getFullYear();

        // Load persisted orders from localStorage if present; otherwise start with an empty list.
        let ordersData = [];
        try {
            ordersData = JSON.parse(localStorage.getItem('orders') || '[]');
            if (!Array.isArray(ordersData)) ordersData = [];
        } catch (e) {
            ordersData = [];
        }

    let currentList = ordersData.slice();
        let sortState = { key: null, asc: true };

        function formatPHP(n){ return 'PHP ' + Number(n).toLocaleString(undefined,{minimumFractionDigits:0}); }

        function titleCase(str){
            if(!str && str !== 0) return '';
            return String(str).split(/(\s+)/).map(token=>{
                // preserve whitespace tokens
                if(/\s+/.test(token)) return token;
                // keep tokens that start with non-letter (numbers, #, TR) unchanged
                if(!/[a-zA-Z]/.test(token.charAt(0))) return token;
                return token.charAt(0).toUpperCase() + token.slice(1);
            }).join('');
        }

        function renderTable(list){
            const tbody = document.getElementById('ordersTbody');
            tbody.innerHTML = '';
            list.forEach((row, idx) => {
                const tr = document.createElement('tr');
                // prefer customerName, fall back to name or saved profile
                var fallbackProfileName = '';
                try{ fallbackProfileName = JSON.parse(sessionStorage.getItem('profile')||localStorage.getItem('profile')||'{}').name || ''; }catch(e){}
                var displayName = row.customerName || row.name || fallbackProfileName || '';
                // build status cell with optional cancel-review button for admin
                var statusHtml = titleCase(row.status || '');
                // show cancel request indicator only when admin has NOT yet confirmed
                if(row.cancellation && !row.cancellation.adminConfirmed && !row.cancellation.adminRevoked){
                    var cancelLabel = (String(row.status||'').toLowerCase() === 'cancelled') ? 'Cancelled' : 'Cancel Requested';
                    statusHtml = '<span style="color:#b71c1c;font-weight:600;">' + cancelLabel + '</span> <button class="cancel-review-btn" data-id="' + (row.id||'') + '" style="background:none;border:none;color:#b71c1c;margin-left:8px;cursor:pointer;font-size:1.05rem;">⚠️</button>';
                }
                // refund indicator (refund_requested or refunded)
                // show refund request indicator only when admin has NOT yet confirmed
                if(row.refund && !row.refund.adminConfirmed && !row.refund.adminRevoked){
                    var refundLabel = (String(row.status||'').toLowerCase() === 'refunded') ? 'Refunded' : 'Refund Requested';
                    statusHtml = '<span style="color:#b71c1c;font-weight:600;">' + refundLabel + '</span> <button class="refund-review-btn" data-id="' + (row.id||'') + '" style="background:none;border:none;color:#b71c1c;margin-left:8px;cursor:pointer;font-size:1.05rem;">⚠️</button>';
                }
            tr.innerHTML = `
                <td style="padding:12px;border-bottom:1px solid #fafafa;">${idx}</td>
                <td style="padding:12px;border-bottom:1px solid #fafafa;">${row.id}</td>
                <td style="padding:12px;border-bottom:1px solid #fafafa;">${titleCase(displayName)}</td>
                    <td style="padding:12px;border-bottom:1px solid #fafafa;">${titleCase(row.date)}</td>
                    <td style="padding:12px;border-bottom:1px solid #fafafa;">${titleCase(row.paymentLabel || row.payment || (row.paymentCode? (row.paymentCode==='qr_ph'? 'QR PH' : (row.paymentCode==='bank_transfer'? 'Bank Transfer' : (row.paymentCode==='cod'? 'Cash on Delivery' : row.paymentCode))) : ''))}</td>
                    <td style="padding:12px;border-bottom:1px solid #fafafa;">${titleCase(row.deliveryMethod || '')}</td>
                    <td style="padding:12px;border-bottom:1px solid #fafafa;">${formatPHP(row.total)}</td>
                    <td style="padding:12px;border-bottom:1px solid #fafafa;">${statusHtml}</td>
                    <td style="padding:12px;border-bottom:1px solid #fafafa;">${titleCase(row.est)}</td>
                    <td style="padding:12px;border-bottom:1px solid #fafafa;">${row.tracking}</td>
                `;
                // open modal when clicking a row
                tr.addEventListener('click', function(){ showOrderModal(row); });
                tbody.appendChild(tr);
            });
            // attach cancel-review and refund-review button handlers
            setTimeout(function(){
                document.querySelectorAll('.cancel-review-btn').forEach(function(btn){
                    btn.addEventListener('click', function(e){
                        e.stopPropagation();
                        var id = btn.getAttribute('data-id');
                        openCancelReviewById(id);
                    });
                });
                document.querySelectorAll('.refund-review-btn').forEach(function(btn){
                    btn.addEventListener('click', function(e){
                        e.stopPropagation();
                        var id = btn.getAttribute('data-id');
                        openRefundReviewById(id);
                    });
                });
            }, 10);
        }

        // Show admin modal formatted like client order popup (uses fields from the row)
        function showOrderModal(row){
            try{
                document.getElementById('adminOrderModalId').textContent = 'Order ID: ' + (row.id || '');
                document.getElementById('adminOrderModalName').textContent = 'Customer: ' + (row.name || '');
                // Date of Order (title-cased)
                document.getElementById('adminOrderModalContact').textContent = 'Date of Order: ' + (titleCase(row.date) || '');
                    // Payment method label (prefer order.paymentLabel)
                    var payLabel = row.paymentLabel || row.payment || '';
                    if(!payLabel && row.paymentCode){
                    if(row.paymentCode === 'qr_ph') payLabel = 'QR PH';
                        else if(row.paymentCode === 'bank_transfer') payLabel = 'Bank Transfer';
                        else if(row.paymentCode === 'cod') payLabel = 'Cash on Delivery';
                    }
                    document.getElementById('adminOrderModalPayment').textContent = payLabel ? ('Payment: ' + payLabel) : '';
                    // Delivery method label
                    var delLabel = row.deliveryLabel || row.deliveryMethod || '';
                    if(!delLabel && row.deliveryCode){
                        if(row.deliveryCode === 'personal') delLabel = 'Personal Delivery';
                        else if(row.deliveryCode === 'lalamove') delLabel = 'Lalamove';
                        else if(row.deliveryCode === 'jnt') delLabel = 'J&T Express';
                    }
                    document.getElementById('adminOrderModalDelivery').textContent = delLabel ? ('Delivery: ' + delLabel) : '';
                document.getElementById('adminOrderModalImg').src = 'IMAGE/NIKE1.png';
                // items: show a simple itemized line using total (admin rows don't have item list)
                document.getElementById('adminOrderModalItems').innerHTML = '<div>' + (row.name || '') + ' — ' + formatPHP(row.total) + '</div>';
                document.getElementById('adminOrderModalTotal').textContent = formatPHP(row.total);
                // create status dropdown inside adminOrderModalStatus
                var statusEl = document.getElementById('adminOrderModalStatus');
                statusEl.innerHTML = '';
                var select = document.createElement('select');
                select.style.padding = '6px 10px';
                select.style.borderRadius = '6px';
                select.style.fontFamily = "'Poppins', Arial, sans-serif";
                var statuses = ['Pending','Confirmed','Shipped','Delivered','Cancelled'];
                statuses.forEach(function(s){
                    var opt = document.createElement('option'); opt.value = s; opt.textContent = s; if(titleCase(row.status) === s) opt.selected = true; select.appendChild(opt);
                });
                select.addEventListener('change', function(){
                    // update underlying row status, persist and re-render table
                    var newStatus = select.value.toLowerCase();
                    updateOrder(row.id, { status: newStatus });
                });
                statusEl.appendChild(document.createTextNode('Status: '));
                statusEl.appendChild(select);

                // editable Est. Delivery date
                var itemsRegion = document.getElementById('adminOrderModalItems');
                var estRow = document.createElement('div'); estRow.style.marginTop = '10px';
                var estLabel = document.createElement('label'); estLabel.textContent = 'Est. Delivery: '; estLabel.style.marginRight = '8px';
                var dateInput = document.createElement('input'); dateInput.type = 'date';
                // parse existing row.est into yyyy-mm-dd if possible
                function toISODate(dstr){
                    var dt = new Date(dstr);
                    if (isNaN(dt.getTime())) return '';
                    var yyyy = dt.getFullYear();
                    var mm = String(dt.getMonth()+1).padStart(2,'0');
                    var dd = String(dt.getDate()).padStart(2,'0');
                    return yyyy+'-'+mm+'-'+dd;
                }
                dateInput.value = row.est ? toISODate(row.est) : '';
                dateInput.style.fontFamily = "'Poppins', Arial, sans-serif";
                dateInput.style.fontSize = '1rem';
                dateInput.style.padding = '6px 8px';
                dateInput.style.border = '1px solid #ddd';
                dateInput.style.borderRadius = '6px';
                dateInput.addEventListener('change', function(){
                    if(dateInput.value){
                            if(!dateInput.value) return;
                            try{
                                var d = new Date(dateInput.value);
                                if(isNaN(d.getTime())) return;
                                // format date using options (year should be 'numeric' not the year number)
                                var estText = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                                // persist the human-friendly est string on the order and refresh
                                updateOrder(row.id, { est: estText });
                            }catch(e){ console.error('failed to parse est date', e); }
                    }
                });
                estRow.appendChild(estLabel); estRow.appendChild(dateInput);
                itemsRegion.appendChild(estRow);
                document.getElementById('adminOrderModalOverlay').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }catch(e){console.error(e)}
        }

        // Update an order in ordersData (and persist to localStorage), then refresh the current view
        function updateOrder(orderId, changes){
            try{
                // find by id using string comparison to avoid type mismatches (number vs string)
                var idx = ordersData.findIndex(o => String(o.id) === String(orderId));
                if(idx === -1) return;
                ordersData[idx] = Object.assign({}, ordersData[idx], changes);
                // persist
                try { localStorage.setItem('orders', JSON.stringify(ordersData)); } catch(e) { console.error('persist failed', e); }
                // reapply current filters/sort and render
                // reload ordersData from storage to ensure consistency, then refresh view
                try{ ordersData = JSON.parse(localStorage.getItem('orders') || '[]'); }catch(e){/* ignore */}
                applySearch();
            }catch(e){console.error(e)}
        }

        // Close admin modal
        document.addEventListener('DOMContentLoaded', function(){
            var closeBtn = document.getElementById('adminOrderModalClose');
            var overlay = document.getElementById('adminOrderModalOverlay');
            if(closeBtn) closeBtn.addEventListener('click', function(){ overlay.style.display='none'; document.body.style.overflow=''; });
            if(overlay) overlay.addEventListener('click', function(e){ if(e.target===overlay){ overlay.style.display='none'; document.body.style.overflow=''; } });
            // Cancel review modal close
            var crClose = document.getElementById('closeCancelReviewBtn');
            if(crClose) crClose.addEventListener('click', function(){ closeCancelReviewModal(); });
            var crOverlay = document.getElementById('cancelReviewModalOverlay');
            if(crOverlay) crOverlay.addEventListener('click', function(e){ if(e.target === crOverlay){ closeCancelReviewModal(); } });
            // admin confirm/revoke handlers
            var revokeBtn = document.getElementById('adminRevokeBtn');
            var confirmBtn = document.getElementById('adminConfirmCancelBtn');
            if(revokeBtn) revokeBtn.addEventListener('click', function(){ adminRevokeCancellation(); });
            if(confirmBtn) confirmBtn.addEventListener('click', function(){ adminConfirmCancellation(); });
            // Refund review modal close
            var rfClose = document.getElementById('refundFooterCloseBtn');
            if(rfClose) rfClose.addEventListener('click', function(){ closeRefundReviewModal(); });
            var rfOverlay = document.getElementById('refundReviewModalOverlay');
            if(rfOverlay) rfOverlay.addEventListener('click', function(e){ if(e.target === rfOverlay){ closeRefundReviewModal(); } });
            var revokeRf = document.getElementById('adminRevokeRefundBtn');
            var confirmRf = document.getElementById('adminConfirmRefundBtn');
            if(revokeRf) revokeRf.addEventListener('click', function(){ adminRevokeRefund(); });
            if(confirmRf) confirmRf.addEventListener('click', function(){ adminConfirmRefund(); });
        });
        // Listen for orders updates from other tabs/windows and refresh
        window.addEventListener('storage', function(e){
            if(e.key === 'orders'){
                try{
                    ordersData = JSON.parse(localStorage.getItem('orders') || '[]');
                    currentList = ordersData.slice();
                    applySort(); renderTable(currentList);
                }catch(err){/* ignore */}
            }
        });

        // Open cancel review modal for a given order id
        function openCancelReviewById(orderId){
            var row = ordersData.find(function(o){ return o.id === orderId; });
            if(!row) return;
            var content = document.getElementById('cancelReviewContent');
            if(!content) return;
            var html = '<div style="font-weight:600;margin-bottom:8px;">Order ID: ' + (row.id||'') + '</div>';
            html += '<div style="margin-bottom:8px;">Customer: ' + (row.name || '') + '</div>';
            if(row.cancellation && row.cancellation.reasons){ html += '<div style="margin-bottom:8px;"><strong>Client reasons:</strong><ul style="margin-top:6px;padding-left:18px;">'; row.cancellation.reasons.forEach(function(r){ html += '<li>' + r + '</li>'; }); html += '</ul></div>'; }
            if(row.cancellation && row.cancellation.timestamp){ html += '<div style="color:#666;font-size:0.95rem;margin-bottom:6px;">Submitted: ' + new Date(row.cancellation.timestamp).toLocaleString() + '</div>'; }
            if(row.cancellation && row.cancellation.adminConfirmed){ html += '<div style="color:green;font-weight:600;margin-bottom:6px;">Admin confirmed cancellation</div>'; }
            // if admin revoked the cancellation, show standardized revocation message and reasons
            if(row.cancellation && row.cancellation.adminRevoked){
                html += '<div style="color:#b71c1c;font-weight:600;margin-bottom:6px;">Cancel Request Was Revoked</div>';
                if(row.cancellation.revocation && row.cancellation.revocation.reasons){
                    html += '<div style="margin-bottom:8px;"><strong>Revocation reasons:</strong><ul style="margin-top:6px;padding-left:18px;">';
                    row.cancellation.revocation.reasons.forEach(function(r){ html += '<li>' + r + '</li>'; });
                    html += '</ul></div>';
                }
            }
            content.innerHTML = html;
            // stash current id
            content.setAttribute('data-order-id', orderId);
            // ensure footer buttons and top close are visible (restore from revoke-form state)
            try{ var cClose = document.getElementById('cancelFooterCloseBtn'); if(cClose) cClose.style.display = ''; }catch(e){}
            try{ var cRevoke = document.getElementById('adminRevokeBtn'); if(cRevoke) cRevoke.style.display = ''; }catch(e){}
            try{ var cConfirm = document.getElementById('adminConfirmCancelBtn'); if(cConfirm) cConfirm.style.display = ''; }catch(e){}
            try{ var topClose = document.getElementById('closeCancelReviewBtn'); if(topClose) topClose.style.display = ''; }catch(e){}
            document.getElementById('cancelReviewModalOverlay').style.display = 'flex'; document.body.style.overflow='hidden';
        }

        function closeCancelReviewModal(){ var o = document.getElementById('cancelReviewModalOverlay'); if(!o) return; o.style.display='none'; document.body.style.overflow=''; }

        function adminConfirmCancellation(){
            var content = document.getElementById('cancelReviewContent'); if(!content) return; var id = content.getAttribute('data-order-id'); if(!id) return;
            var idx = ordersData.findIndex(function(o){ return o.id === id; }); if(idx === -1) return;
            ordersData[idx].cancellation = ordersData[idx].cancellation || {};
            ordersData[idx].cancellation.adminConfirmed = true;
            // ensure status is Cancelled (admin confirmed)
            ordersData[idx].status = 'Cancelled';
            localStorage.setItem('orders', JSON.stringify(ordersData));
            applySearch(); closeCancelReviewModal();
        }

        function adminRevokeCancellation(){
            // Instead of immediately revoking, open a revocation form to collect reasons (similar to refund revoke flow)
            var content = document.getElementById('cancelReviewContent'); if(!content) return; var id = content.getAttribute('data-order-id'); if(!id) return;
            openCancelRevokeForm(id);
        }

        // Render the admin revoke form for cancellations (checkbox reasons + Other textbox)
        function openCancelRevokeForm(orderId){
            var content = document.getElementById('cancelReviewContent'); if(!content) return;
            var html = '<div style="font-weight:600;margin-bottom:8px;">Revoke Cancellation</div>';
            html += '<div style="margin-bottom:8px;">Select reason(s) for revoking this cancellation request:</div>';
            html += '<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:8px;">';
            var reasons = [
                'Cancellation Policy Violation',
                'Order Being Shipped',
                'Other'
            ];
            reasons.forEach(function(r, i){
                if(r === 'Other'){
                    html += '<label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" class="adminCancelRevokeReason" id="adminCancelOtherChk" /> Other: <input id="adminCancelOtherText" type="text" placeholder="Specify other reason" style="margin-left:8px;flex:1;padding:8px;border:1px solid #ddd;border-radius:6px;" /></label>';
                } else {
                    html += '<label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" class="adminCancelRevokeReason" data-reason="' + r.replace(/"/g,'&quot;') + '" /> ' + r + '</label>';
                }
            });
            html += '</div>';
            html += '<div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;flex-wrap:nowrap;">';
            html += '<button id="backToCancelBtn" style="background:#fff;border:1px solid #ccc;padding:8px 14px;border-radius:10px;cursor:pointer;display:inline-block;min-width:110px;">Go Back</button>';
            html += '<button id="confirmAdminCancelRevokeBtn" style="background:#b71c1c;color:#fff;border:none;padding:8px 14px;border-radius:10px;cursor:pointer;display:inline-block;min-width:120px;">Confirm Revoke</button>';
            html += '</div>';
            content.innerHTML = html;
            content.setAttribute('data-order-id', orderId);
            // wire buttons
            setTimeout(function(){
                var back = document.getElementById('backToCancelBtn'); if(back) back.addEventListener('click', function(){ openCancelReviewById(orderId); });
                var confirm = document.getElementById('confirmAdminCancelRevokeBtn'); if(confirm) confirm.addEventListener('click', function(){ adminConfirmRevokeCancellation(); });
            }, 10);
            // hide the modal footer default buttons while revocation form is shown
            try{ var cClose = document.getElementById('cancelFooterCloseBtn'); if(cClose) cClose.style.display = 'none'; }catch(e){}
            try{ var cRevoke = document.getElementById('adminRevokeBtn'); if(cRevoke) cRevoke.style.display = 'none'; }catch(e){}
            try{ var cConfirm = document.getElementById('adminConfirmCancelBtn'); if(cConfirm) cConfirm.style.display = 'none'; }catch(e){}
            // hide the top-right close (X) while revocation form is shown
            try{ var topClose = document.getElementById('closeCancelReviewBtn'); if(topClose) topClose.style.display = 'none'; }catch(e){}
        }

        // Confirm the admin revoke for cancellation: collect reasons, validate, persist revocation metadata and restore previous status
        function adminConfirmRevokeCancellation(){
            var content = document.getElementById('cancelReviewContent'); if(!content) return; var id = content.getAttribute('data-order-id'); if(!id) return;
            var checks = Array.prototype.slice.call(document.querySelectorAll('.adminCancelRevokeReason'));
            var selections = [];
            checks.forEach(function(ch){ if(ch.checked){ if(ch.id === 'adminCancelOtherChk'){ var t = (document.getElementById('adminCancelOtherText')||{}).value || ''; if(t && t.trim().length > 2) selections.push(t.trim()); } else { selections.push(ch.getAttribute('data-reason')); } } });
            if(selections.length === 0){ alert('Please select at least one reason or provide details in Other.'); return; }
            var idx = ordersData.findIndex(function(o){ return String(o.id) === String(id); }); if(idx === -1) return;
            ordersData[idx].cancellation = ordersData[idx].cancellation || {};
            ordersData[idx].cancellation.adminRevoked = true;
            ordersData[idx].cancellation.revocation = { reasons: selections, timestamp: new Date().toISOString() };
            // restore previous status
            var prev = ordersData[idx].previousStatus || 'Pending';
            ordersData[idx].status = prev;
            delete ordersData[idx].previousStatus;
            localStorage.setItem('orders', JSON.stringify(ordersData));
            applySearch(); closeCancelReviewModal();
        }

        // Refund review functions
        function openRefundReviewById(orderId){
            var row = ordersData.find(function(o){ return String(o.id) === String(orderId); });
            if(!row) return;
            var content = document.getElementById('refundReviewContent'); if(!content) return;
            var html = '<div style="font-weight:600;margin-bottom:8px;">Order ID: ' + (row.id||'') + '</div>';
            html += '<div style="margin-bottom:8px;">Customer: ' + (row.name || '') + '</div>';
            if(row.refund && row.refund.reasons){ html += '<div style="margin-bottom:8px;"><strong>Client refund reasons:</strong><ul style="margin-top:6px;padding-left:18px;">'; row.refund.reasons.forEach(function(r){ html += '<li>' + r + '</li>'; }); html += '</ul></div>'; }
            if(row.refund && row.refund.timestamp){ html += '<div style="color:#666;font-size:0.95rem;margin-bottom:6px;">Submitted: ' + new Date(row.refund.timestamp).toLocaleString() + '</div>'; }
            if(row.refund && row.refund.proof){ html += '<div style="margin-top:8px;margin-bottom:8px;"><strong>Uploaded proof:</strong><div style="margin-top:8px;"><img src="' + row.refund.proof + '" alt="Proof" style="max-width:320px;border:1px solid #eee;border-radius:8px;object-fit:contain;"/></div></div>'; }
            if(row.refund && row.refund.adminConfirmed){ html += '<div style="color:green;font-weight:600;margin-bottom:6px;">Admin confirmed refund</div>'; }
            if(row.refund && row.refund.adminRevoked && row.refund.revocation){ html += '<div style="color:#b71c1c;font-weight:600;margin-bottom:6px;">Refund Request Was Revoked</div>'; html += '<div style="margin-bottom:8px;"><strong>Revocation reasons:</strong><ul style="margin-top:6px;padding-left:18px;">'; row.refund.revocation.reasons.forEach(function(r){ html += '<li>' + r + '</li>'; }); html += '</ul></div>'; }
            content.innerHTML = html;
            content.setAttribute('data-order-id', orderId);
            // ensure footer buttons for refund review are visible when showing the review
            try{ var fClose = document.getElementById('refundFooterCloseBtn'); if(fClose) fClose.style.display = ''; }catch(e){}
            try{ var rRevoke = document.getElementById('adminRevokeRefundBtn'); if(rRevoke) rRevoke.style.display = ''; }catch(e){}
            try{ var rConfirm = document.getElementById('adminConfirmRefundBtn'); if(rConfirm) rConfirm.style.display = ''; }catch(e){}
            document.getElementById('refundReviewModalOverlay').style.display = 'flex'; document.body.style.overflow='hidden';
        }

        function closeRefundReviewModal(){ var o = document.getElementById('refundReviewModalOverlay'); if(!o) return; o.style.display='none'; document.body.style.overflow=''; }

        function adminConfirmRefund(){
            var content = document.getElementById('refundReviewContent'); if(!content) return; var id = content.getAttribute('data-order-id'); if(!id) return;
            var idx = ordersData.findIndex(function(o){ return String(o.id) === String(id); }); if(idx === -1) return;
            ordersData[idx].refund = ordersData[idx].refund || {};
            ordersData[idx].refund.adminConfirmed = true;
            ordersData[idx].status = 'Refunded';
            localStorage.setItem('orders', JSON.stringify(ordersData));
            applySearch(); closeRefundReviewModal();
        }

        // When admin clicks Revoke (first step), show a revocation reasons form inside the same modal
        function adminRevokeRefund(){
            var content = document.getElementById('refundReviewContent'); if(!content) return; var id = content.getAttribute('data-order-id'); if(!id) return;
            openRefundRevokeForm(id);
        }

        // Render the admin revoke form (checkbox reasons + Other textbox)
        function openRefundRevokeForm(orderId){
            var content = document.getElementById('refundReviewContent'); if(!content) return;
            var html = '<div style="font-weight:600;margin-bottom:8px;">Revoke Refund</div>';
            html += '<div style="margin-bottom:8px;">Select reason(s) for revoking this refund request:</div>';
            html += '<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:8px;">';
            var reasons = [
                'Policy Violations',
                'Product Condition',
                'Customer Error',
                'Refusal of Delivery without Valid Cause',
                'Proof of Delivery',
                'Lack of Evidence',
                'Prior Refund/Chargeback',
                'Fraudulent Behavior'
            ];
            reasons.forEach(function(r, i){
                html += '<label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" class="adminRevokeReason" data-reason="' + r.replace(/"/g,'&quot;') + '" /> ' + r + '</label>';
            });
            html += '<label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" class="adminRevokeReason" id="adminRevokeOtherChk" /> Other: <input id="adminRevokeOtherText" type="text" placeholder="Specify other reason" style="margin-left:8px;flex:1;padding:8px;border:1px solid #ddd;border-radius:6px;" /></label>';
            html += '</div>';
            // use compact inline buttons: Go Back and Confirm Revoke
            html += '<div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;flex-wrap:nowrap;">';
            html += '<button id="backToRefundBtn" style="background:#fff;border:1px solid #ccc;padding:8px 14px;border-radius:10px;cursor:pointer;display:inline-block;min-width:110px;">Go Back</button>';
            html += '<button id="confirmAdminRevokeBtn" style="background:#b71c1c;color:#fff;border:none;padding:8px 14px;border-radius:10px;cursor:pointer;display:inline-block;min-width:120px;">Confirm Revoke</button>';
            html += '</div>';
            content.innerHTML = html;
            content.setAttribute('data-order-id', orderId);
            // wire buttons
            setTimeout(function(){
                var back = document.getElementById('backToRefundBtn'); if(back) back.addEventListener('click', function(){ openRefundReviewById(orderId); });
                var confirm = document.getElementById('confirmAdminRevokeBtn'); if(confirm) confirm.addEventListener('click', function(){ adminConfirmRevokeRefund(); });
            }, 10);
            // hide the modal footer default buttons while revocation form is shown
            try{ var fClose = document.getElementById('refundFooterCloseBtn'); if(fClose) fClose.style.display = 'none'; }catch(e){}
            try{ var rRevoke = document.getElementById('adminRevokeRefundBtn'); if(rRevoke) rRevoke.style.display = 'none'; }catch(e){}
            try{ var rConfirm = document.getElementById('adminConfirmRefundBtn'); if(rConfirm) rConfirm.style.display = 'none'; }catch(e){}
        }

        // Confirm the admin revoke: collect reasons, validate, persist revocation metadata and restore previous status
        function adminConfirmRevokeRefund(){
            var content = document.getElementById('refundReviewContent'); if(!content) return; var id = content.getAttribute('data-order-id'); if(!id) return;
            var checks = Array.prototype.slice.call(document.querySelectorAll('.adminRevokeReason'));
            var selections = [];
            checks.forEach(function(ch){ if(ch.checked){ if(ch.id === 'adminRevokeOtherChk'){ var t = (document.getElementById('adminRevokeOtherText')||{}).value || ''; if(t && t.trim().length > 2) selections.push(t.trim()); } else { selections.push(ch.getAttribute('data-reason')); } } });
            if(selections.length === 0){ alert('Please select at least one reason or provide details in Other.'); return; }
            var idx = ordersData.findIndex(function(o){ return String(o.id) === String(id); }); if(idx === -1) return;
            ordersData[idx].refund = ordersData[idx].refund || {};
            ordersData[idx].refund.adminRevoked = true;
            ordersData[idx].refund.revocation = { reasons: selections, timestamp: new Date().toISOString() };
            // restore previous status
            var prev = ordersData[idx].previousStatus || 'Pending';
            ordersData[idx].status = prev;
            delete ordersData[idx].previousStatus;
            localStorage.setItem('orders', JSON.stringify(ordersData));
            applySearch(); closeRefundReviewModal();
        }

        function matchesSearch(row, q){
            if(!q) return true;
            q = q.toLowerCase();
            return (row.id + ' ' + (row.customerName || row.name) + ' ' + row.date + ' ' + row.payment + ' ' + row.total + ' ' + row.status + ' ' + row.est + ' ' + row.tracking).toLowerCase().indexOf(q) !== -1;
        }

        function applySearch(){
            const q = document.getElementById('ordersSearch').value.trim();
            const filtered = ordersData.filter(r => matchesSearch(r, q));
            currentList = filtered;
            applySort();
            renderTable(currentList);
        }

        function applySort(){
            if(!sortState.key) return;
            currentList.sort((a,b)=>{
                let A=a[sortState.key];
                let B=b[sortState.key];
                if(sortState.key==='total'){
                    return sortState.asc ? A-B : B-A;
                }
                if(sortState.key==='date'){
                    return sortState.asc ? new Date(A) - new Date(B) : new Date(B) - new Date(A);
                }
                // string compare
                A = (A||'').toString().toLowerCase();
                B = (B||'').toString().toLowerCase();
                if(A < B) return sortState.asc ? -1 : 1;
                if(A > B) return sortState.asc ? 1 : -1;
                return 0;
            });
        }

        document.addEventListener('DOMContentLoaded', function(){
            renderTable(currentList);
            document.getElementById('ordersSearch').addEventListener('input', function(){ applySearch(); });
            document.querySelectorAll('.filter-btn').forEach(btn=>{
                btn.addEventListener('click', function(){
                    const keyMap = { date: 'date', payment: 'payment', id: 'id', status: 'status' };
                    const key = keyMap[btn.dataset.sort];
                    if(sortState.key === key){ sortState.asc = !sortState.asc; } else { sortState.key = key; sortState.asc = true; }
                    applySort();
                    renderTable(currentList);
                });
            });
        });
    })();
    // Sticky footer fallback for short content
    function stickyFooter() {
        var body = document.body,
            html = document.documentElement,
            footer = document.querySelector('footer');
        if(!footer) return; // nothing to do when there is no footer on the page
        var contentHeight = Math.max(body.scrollHeight, body.offsetHeight,
            html.clientHeight, html.scrollHeight, html.offsetHeight);
        if (contentHeight < window.innerHeight) {
            footer.style.position = 'fixed';
            footer.style.left = '0';
            footer.style.right = '0';
            footer.style.bottom = '0';
        } else {
            footer.style.position = 'relative';
        }
    }
    window.addEventListener('load', stickyFooter);
    window.addEventListener('resize', stickyFooter);
    </script>
    <script src="cart-storage.js"></script>

</body>

    <!-- ===== Cart Overlay + Sidebar HTML (universal) ===== -->
    <div id="cartOverlay" class="cart-overlay" aria-hidden="true"></div>
    <aside id="cartSidebar" class="cart-sidebar" aria-hidden="true" role="complementary">
        <div class="cart-header-row">
            <div>
                <span class="cart-header-title">Cart (<span id="cartCount">0</span>)</span>
            </div>
            <button id="closeCartBtn" class="cart-close" aria-label="Close cart"><img src="IMAGE/X.png" alt="Close" style="width:20px;height:20px;"></button>
        </div>
        <div class="cart-divider"></div>
        <div id="cartItems" class="cart-items">
            <div class="cart-empty">Your cart is empty</div>
        </div>
        <div class="cart-divider"></div>
        <div class="cart-subtotal-row">
            <span class="cart-subtotal-label">Subtotal</span>
            <span id="cartSubtotal" class="cart-subtotal-value">₱0.00</span>
        </div>
        <button id="checkoutBtn" class="cart-checkout-btn">Checkout</button>
    </aside>
    <!-- ===== Cart Sidebar Behavior (universal) ===== -->
    <script>
    (function(){
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        function parsePriceToNumber(priceText) {
            if (!priceText) return 0;
            var v = priceText.replace(/[^0-9.]/g, '');
            return parseFloat(v || 0);
        }
        function formatPHP(amount) {
            try {
                return new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(amount);
            } catch (e) {
                return '₱' + Number(amount).toFixed(2);
            }
        }
        function saveCartToLocalStorage() {
            localStorage.setItem('cart', JSON.stringify(cart));
        }
        const cartOverlay = document.getElementById('cartOverlay');
        const cartSidebar = document.getElementById('cartSidebar');
        const cartItemsContainer = document.getElementById('cartItems');
        const cartCountEl = document.getElementById('cartCount');
        const cartSubtotalEl = document.getElementById('cartSubtotal');
        const closeCartBtn = document.getElementById('closeCartBtn');
        const checkoutBtn = document.getElementById('checkoutBtn');
        function getNavCartButton() {
            const img = document.querySelector('img[alt="Cart"]');
            if (!img) return null;
            return img.closest('button');
        }
        function openCartSidebar() {
            cartOverlay.classList.add('show');
            cartSidebar.classList.add('open');
            document.body.style.overflow = 'hidden';
            cartSidebar.setAttribute('aria-hidden', 'false');
            cartOverlay.setAttribute('aria-hidden', 'false');
        }
        function closeCartSidebar() {
            cartOverlay.classList.remove('show');
            cartSidebar.classList.remove('open');
            document.body.style.overflow = '';
            cartSidebar.setAttribute('aria-hidden', 'true');
            cartOverlay.setAttribute('aria-hidden', 'true');
        }
        function renderCart() {
            cartItemsContainer.innerHTML = '';
            if (cart.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'cart-empty';
                empty.textContent = 'Your cart is empty';
                cartItemsContainer.appendChild(empty);
                cartCountEl.textContent = 0;
                cartSubtotalEl.textContent = formatPHP(0);
                saveCartToLocalStorage();
                return;
            }
            let subtotal = 0;
            let totalQty = 0;
            cart.forEach((item, index) => {
                subtotal += item.price * item.quantity;
                totalQty += item.quantity;
                const box = document.createElement('div');
                box.className = 'cart-item-box';
                const img = document.createElement('img');
                img.className = 'cart-item-img';
                img.src = item.image || 'IMAGE/NIKE1.png';
                img.alt = item.title || 'Product';
                const middle = document.createElement('div');
                middle.className = 'cart-item-middle';
                const title = document.createElement('div');
                title.className = 'cart-item-title';
                title.textContent = item.title;
                const brand = document.createElement('div');
                brand.className = 'cart-item-brand';
                brand.textContent = item.brand;
                const size = document.createElement('div');
                size.className = 'cart-item-size';
                size.textContent = 'Size: ' + (item.size || '');
                const qtyControls = document.createElement('div');
                qtyControls.className = 'cart-quantity-controls';
                const lessenBtn = document.createElement('button');
                lessenBtn.className = 'qty-btn decrease';
                lessenBtn.setAttribute('data-index', index);
                const lessenImg = document.createElement('img');
                lessenImg.src = 'IMAGE/LessenBTN.png';
                lessenImg.alt = '-';
                lessenImg.style.width = '22px';
                lessenImg.style.height = '22px';
                lessenBtn.appendChild(lessenImg);
                const qtyText = document.createElement('span');
                qtyText.className = 'cart-item-qty';
                qtyText.textContent = item.quantity;
                const addBtn = document.createElement('button');
                addBtn.className = 'qty-btn increase';
                addBtn.setAttribute('data-index', index);
                const addImg = document.createElement('img');
                addImg.src = 'IMAGE/AddBTN.png';
                addImg.alt = '+';
                addImg.style.width = '22px';
                addImg.style.height = '22px';
                addBtn.appendChild(addImg);
                qtyControls.appendChild(lessenBtn);
                qtyControls.appendChild(qtyText);
                qtyControls.appendChild(addBtn);
                middle.appendChild(title);
                middle.appendChild(brand);
                middle.appendChild(size);
                middle.appendChild(qtyControls);
                const removeBtn = document.createElement('button');
                removeBtn.className = 'cart-item-remove';
                removeBtn.setAttribute('data-index', index);
                const trashImg = document.createElement('img');
                trashImg.src = 'IMAGE/TrashIcon.png';
                trashImg.alt = 'Remove';
                trashImg.style.width = '18px';
                trashImg.style.height = '18px';
                removeBtn.appendChild(trashImg);
                const priceEl = document.createElement('div');
                priceEl.className = 'cart-item-price';
                priceEl.textContent = formatPHP(item.price * item.quantity);
                box.appendChild(img);
                box.appendChild(middle);
                box.appendChild(removeBtn);
                box.appendChild(priceEl);
                cartItemsContainer.appendChild(box);
            });
            cartCountEl.textContent = totalQty;
            cartSubtotalEl.textContent = formatPHP(subtotal);
            attachCartEvents();
        }
        function attachCartEvents() {
            document.querySelectorAll('.qty-btn.decrease').forEach(btn => {
                btn.onclick = function(e) {
                    const idx = parseInt(btn.getAttribute('data-index'), 10);
                    if (!isNaN(idx) && cart[idx]) {
                        if (cart[idx].quantity > 1) {
                            cart[idx].quantity--;
                        }
                        renderCart();
                        saveCartToLocalStorage();
                    }
                };
            });
            document.querySelectorAll('.qty-btn.increase').forEach(btn => {
                btn.onclick = function(e) {
                    const idx = parseInt(btn.getAttribute('data-index'), 10);
                    if (!isNaN(idx) && cart[idx]) {
                        cart[idx].quantity++;
                        renderCart();
                        saveCartToLocalStorage();
                    }
                };
            });
            document.querySelectorAll('.cart-item-remove').forEach(btn => {
                btn.onclick = function(e) {
                    const idx = parseInt(btn.getAttribute('data-index'), 10);
                    if (!isNaN(idx)) {
                        cart.splice(idx, 1);
                        renderCart();
                        saveCartToLocalStorage();
                    }
                };
            });
        }
        document.addEventListener('DOMContentLoaded', function() {
            const navCartBtn = getNavCartButton();
            if (navCartBtn) {
                navCartBtn.removeAttribute('onclick');
                navCartBtn.addEventListener('click', function(e){
                    e.preventDefault();
                    openCartSidebar();
                });
            }
            if (closeCartBtn) closeCartBtn.addEventListener('click', closeCartSidebar);
            if (cartOverlay) cartOverlay.addEventListener('click', closeCartSidebar);
            renderCart();
            if (checkoutBtn) {
                checkoutBtn.addEventListener('click', function(){
                    window.location.href = 'checkout.html';
                });
            }
        });
    })();
    </script>
                 <style>
                     .orders-body {
                         min-height: 100vh;
                         display: flex;
                         flex-direction: column;
                     }
                     main.orders-main {
                         flex: 1 0 auto;
                         min-height: 0;
                         display: flex;
                         flex-direction: column;
                     }
                 </style>
