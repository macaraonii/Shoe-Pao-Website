<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Shoe Pao — Accounts</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        :root{--accent:#b71c1c;--muted:#666;--page-bg:#fafafa}
        body{font-family:'Poppins',Arial,sans-serif;margin:0;background:var(--page-bg);color:#222}
        .topbar{background:#fff;display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid #eee;position:sticky;top:0;z-index:50}
        .nav-left{display:flex;align-items:center;gap:22px;width:70%;max-width:820px}
        .nav-left-inner{display:flex;align-items:center;justify-content:space-between;width:100%}
        .logo-wrap{display:flex;align-items:center;gap:12px;text-decoration:none;color:inherit}
        .logo-wrap img{height:40px}
        .site-title{font-weight:600;color:var(--accent);font-size:1.05rem}
        .nav-item{font-size:0.98rem;font-weight:500;color:#222;cursor:pointer;text-decoration:none;padding:8px 12px;border-radius:6px}
        .nav-item:hover{color:var(--accent)}
        .nav-right{display:flex;align-items:center;gap:12px}
        .profile-btn{background:none;border:0;padding:6px;cursor:pointer}
        .profile-btn img{width:34px;height:34px}
        .container{max-width:1100px;margin:28px auto;padding:20px}
        .page-title{font-size:1.6rem;font-weight:700;margin-bottom:6px}
        .sub{color:var(--muted);margin-bottom:12px}
        table.accounts-table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #eee;border-radius:8px;overflow:hidden}
        table.accounts-table th, table.accounts-table td{padding:12px 14px;border-bottom:1px solid #f0f0f0;text-align:left}
        table.accounts-table thead th{background:#fafafa;font-weight:700}
        .empty{color:#666;padding:24px;text-align:center}
        .action-link{color:var(--accent);text-decoration:none;font-weight:600}
    .search-row{display:flex;gap:8px;margin-bottom:12px;align-items:center}
    /* visually prominent white search box with black outline */
    .search-box{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid #000;border-radius:10px;padding:6px 8px;box-shadow:none}
    .search-icon{width:20px;height:20px;opacity:0.85}
    .search-input{flex:1;padding:10px 12px;border:0;background:transparent;border-radius:6px;outline:none;font-size:0.95rem;min-width:320px}
    </style>
</head>
<body>
    <header class="topbar">
        <div class="nav-left">
            <div class="nav-left-inner">
                <a class="logo-wrap" href="dashboard.html" aria-label="Shoe Pao dashboard">
                    <img src="IMAGE/SHOEPAOLOGO.png" alt="ShoePao logo">
                    <span class="site-title">Shoe Pao Footwear</span>
                </a>
                <a class="nav-item" href="dashboard.html">OVERVIEW</a>
                <a class="nav-item" href="orders.html">Orders</a>
                <a class="nav-item" href="inventory.html">Inventory</a>
                <a class="nav-item" href="accounts.html">Accounts</a>
            </div>
        </div>
        <div class="nav-right">
            <button class="profile-btn" onclick="location.href='profile.html'" aria-label="Profile">
                <img src="IMAGE/USERICON.png" alt="User">
            </button>
        </div>
    </header>

    <main class="container">
        <div class="page-title">Accounts</div>
        <div class="sub">List of registered users. Click a row to view details and orders.</div>

        <div style="margin-bottom:12px;display:flex;gap:12px;align-items:center;justify-content:space-between;">
            <div style="flex:1 1 72%">
                <div class="search-row">
                    <div class="search-box" style="width:100%;">
                        <img src="IMAGE/SEARCHICON.png" class="search-icon" alt="Search">
                        <input id="accountsSearch" class="search-input" placeholder="Search by name, email, or phone number" aria-label="Search accounts" />
                    </div>
                </div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
                <label for="typeFilter" style="font-size:0.95rem;color:#444">Type</label>
                <select id="typeFilter" style="padding:8px;border-radius:8px;border:1px solid #ddd;background:#fff">
                    <option value="all">All</option>
                    <option value="admin">Admin</option>
                    <option value="client">Client</option>
                </select>
                <label for="alphaSort" style="font-size:0.95rem;color:#444">Sort</label>
                <select id="alphaSort" style="padding:8px;border-radius:8px;border:1px solid #ddd;background:#fff">
                    <option value="none">Default</option>
                    <option value="az">A → Z</option>
                    <option value="za">Z → A</option>
                </select>
                <button id="createAccountBtn" style="margin-left:12px;padding:8px 12px;border-radius:8px;border:1px solid #000;background:#000;color:#fff;cursor:pointer;min-width:140px;white-space:nowrap;font-weight:400;font-size:0.95rem">Create Account</button>
            </div>
        </div>

        <div id="accountsWrap">
            <table class="accounts-table" id="accountsTable">
                <thead>
                    <tr>
                    <th>Full name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Type</th>
                    <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="accountsTbody">
                </tbody>
            </table>
        </div>

    </main>

    <script>
    (function(){
        function getUsers(){ try{ return JSON.parse(localStorage.getItem('users') || '[]') }catch(e){ return [] } }
        function formatName(u){ if(!u) return 'EMPTY'; var first = (u.firstName || u.name || '').trim(); var last = (u.lastName || '').trim(); var full = (first + (last ? (' ' + last) : '')).trim(); return full || 'EMPTY'; }

        function render(){
            var users = getUsers() || [];
            // Backfill missing user names from orders if possible (persist so it appears in profiles/accounts)
            try{
                var orders = JSON.parse(localStorage.getItem('orders')||'[]') || [];
                var didUpdate = false;
                users = users.map(function(u){
                    var hasName = (u.firstName && u.firstName.trim()) || (u.lastName && u.lastName.trim()) || (u.name && u.name.trim());
                    if(hasName) return u;
                    var email = (u.email||'').toLowerCase();
                    if(!email) return u;
                    var found = orders.find(function(o){
                        var candidates = [o.email, o.customerEmail, (o.profile && o.profile.email), (o.customer && o.customer.email)];
                        return candidates.some(function(c){ return (c||'').toLowerCase() === email; }) && o.customerName;
                    });
                    if(found && found.customerName){
                        // persist the name into user's name fields
                        var parts = (found.customerName||'').trim().split(/\s+/);
                        if(parts.length === 1){ u.firstName = parts[0]; }
                        else if(parts.length > 1){ u.firstName = parts.shift(); u.lastName = parts.join(' '); }
                        else { u.name = found.customerName; }
                        didUpdate = true;
                    }
                    return u;
                });
                if(didUpdate){ localStorage.setItem('users', JSON.stringify(users)); }
                }catch(e){ /* ignore */ }
            const tbody = document.getElementById('accountsTbody');
            tbody.innerHTML = '';
            if(!users || users.length===0){ document.getElementById('accountsWrap').innerHTML = '<div class="empty">No accounts found.</div>'; return; }
            const q = (document.getElementById('accountsSearch').value || '').toLowerCase().trim();
            const typeFilter = (document.getElementById('typeFilter').value || 'all');
            const alphaSort = (document.getElementById('alphaSort').value || 'none');

            // filter by search and type
            let filtered = users.filter(u=>{
                // type filter
                const role = (u.role||'').toLowerCase();
                if(typeFilter === 'admin' && role !== 'admin') return false;
                if(typeFilter === 'client' && role === 'admin') return false;
                // search
                if(!q) return true;
                const joined = (formatName(u) + ' ' + (u.email||'') + ' ' + (u.phone||'')).toLowerCase();
                return joined.indexOf(q) !== -1;
            });

            // Always show admins on top when viewing All; apply alphabetical sort within groups if requested
            const rolePriority = (u) => ((u.role||'').toLowerCase() === 'admin') ? 0 : 1;

            filtered.sort(function(a,b){
                // primary: role priority
                const pa = rolePriority(a), pb = rolePriority(b);
                if(pa !== pb) return pa - pb;
                // secondary: alphabetical if requested
                if(alphaSort === 'az' || alphaSort === 'za'){
                    const na = formatName(a).toLowerCase();
                    const nb = formatName(b).toLowerCase();
                    if(na < nb) return (alphaSort === 'az') ? -1 : 1;
                    if(na > nb) return (alphaSort === 'az') ? 1 : -1;
                    return 0;
                }
                // otherwise keep stable order (fallback to name asc)
                const na = formatName(a).toLowerCase();
                const nb = formatName(b).toLowerCase();
                return na < nb ? -1 : (na > nb ? 1 : 0);
            });

            filtered.forEach(u=>{
                const tr = document.createElement('tr');
                const name = formatName(u);
                const email = u.email || 'EMPTY';
                const phone = u.phone || 'EMPTY';
                const type = (u.role && u.role.toLowerCase() === 'admin') ? 'Admin' : 'Client';
                tr.innerHTML = '<td>' + name + '</td><td>' + email + '</td><td>' + phone + '</td><td>' + type + '</td><td>' +
                    '<a class="action-link" href="account-detail.html?email=' + encodeURIComponent(email) + '">View</a>' +
                    ' <button class="action-btn edit-btn" data-email="' + encodeURIComponent(email) + '" style="margin-left:8px;padding:6px 10px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer">Edit</button>' +
                    ' <button class="action-btn delete-btn" data-email="' + encodeURIComponent(email) + '" style="margin-left:6px;padding:6px 10px;border-radius:6px;border:1px solid #b71c1c;background:#fff;color:#b71c1c;cursor:pointer">Delete</button>' +
                    '</td>';
                tr.style.cursor = 'pointer';
                tr.onclick = function(e){
                    // if clicked the link or a button, let that control handle it
                    if(e.target && e.target.tagName){
                        var t = e.target.tagName.toLowerCase();
                        if(t === 'a') return;
                        if(e.target.closest && e.target.closest('.action-btn')) return;
                    }
                    window.location.href = 'account-detail.html?email=' + encodeURIComponent(email);
                };
                tbody.appendChild(tr);
            });
        }

        document.getElementById('accountsSearch').addEventListener('input', function(){ render(); });
        var tf = document.getElementById('typeFilter'); if(tf) tf.addEventListener('change', function(){ render(); });
        var as = document.getElementById('alphaSort'); if(as) as.addEventListener('change', function(){ render(); });
        window.addEventListener('storage', function(e){ if(e.key === 'users' || e.key === 'orders') render(); });
        document.addEventListener('DOMContentLoaded', render);
    })();
    </script>

    <script>
    // Utility used by modal phone input
    function formatPhone(input) {
        var value = (input.value||'').replace(/\D/g, '');
        var formatted = '';
        if (value.length > 0) formatted += value.substring(0,3);
        if (value.length > 3) formatted += ' ' + value.substring(3,6);
        if (value.length > 6) formatted += ' ' + value.substring(6,10);
        input.value = formatted;
    }

    // Modal + create/edit/delete wiring
    (function(){
        var modalHtml = '\n<div id="accountModal" style="display:none;position:fixed;inset:0;z-index:20000;align-items:center;justify-content:center;">' +
            '<div id="modalOverlay" style="position:absolute;inset:0;background:rgba(0,0,0,0.5)"></div>' +
            '<div style="position:relative;max-width:560px;width:94%;background:#fff;border-radius:10px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,0.15);z-index:20001">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">' +
            '<div style="font-weight:700;font-size:1.15rem" id="modalTitle">Create account</div>' +
            '<button id="closeModalBtn" style="background:none;border:0;font-size:1.2rem;cursor:pointer">✕</button>' +
            '</div>' +
            '<form id="accountForm" autocomplete="off" style="display:block">' +
            '<div style="display:flex;gap:10px;margin-bottom:8px">' +
            '<input id="firstName_m" placeholder="First name" required style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px">' +
            '<input id="lastName_m" placeholder="Last name" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px">' +
            '</div>' +
            '<div style="margin-bottom:8px"><input id="email_m" type="email" placeholder="Email" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px"></div>' +
            '<div style="margin-bottom:8px"><input id="phone_m" placeholder="Phone (xxx xxx xxxx)" maxlength="12" oninput="formatPhone(this)" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px"></div>' +
            '<div style="margin-bottom:8px"><input id="password_m" type="password" placeholder="Password (leave blank to keep existing)" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px"></div>' +
            '<div style="margin-bottom:12px"><label for="role_m">Role</label> <select id="role_m" style="margin-left:8px;padding:8px;border-radius:6px;border:1px solid #ddd"><option value="client">Client</option><option value="admin">Admin</option></select></div>' +
            '<div style="display:flex;gap:8px;justify-content:flex-end">' +
            '<button type="button" id="cancelModal" style="padding:8px 12px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer">Cancel</button>' +
            '<button type="submit" id="saveAccountBtn" style="padding:8px 14px;border-radius:6px;border:0;background:#000;color:#fff;cursor:pointer">Save</button>' +
            '</div>' +
            '</form>' +
            '</div></div>\n';
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        var modal = document.getElementById('accountModal');
        var closeBtn = document.getElementById('closeModalBtn');
        var cancelBtn = document.getElementById('cancelModal');
        var form = document.getElementById('accountForm');
        var modalTitle = document.getElementById('modalTitle');
        var createBtn = document.getElementById('createAccountBtn');
    var currentMode = 'create';
    var editingEmail = null;

        function openAccountModal(mode, email){
            currentMode = mode || 'create';
            editingEmail = email || null;
            modalTitle.textContent = (currentMode === 'create') ? 'Create account' : 'Edit account';
            document.getElementById('firstName_m').value = '';
            document.getElementById('lastName_m').value = '';
            document.getElementById('email_m').value = '';
            document.getElementById('phone_m').value = '';
            document.getElementById('password_m').value = '';
            document.getElementById('role_m').value = 'client';
            if(currentMode === 'edit' && editingEmail){
                try{
                    var users = JSON.parse(localStorage.getItem('users')||'[]')||[];
                    var u = users.find(function(x){ return (x.email||'').toLowerCase() === (decodeURIComponent(editingEmail)||'').toLowerCase(); });
                    if(u){
                        document.getElementById('firstName_m').value = u.firstName || u.name || '';
                        document.getElementById('lastName_m').value = u.lastName || '';
                        document.getElementById('email_m').value = u.email || '';
                        document.getElementById('phone_m').value = u.phone || '';
                        document.getElementById('role_m').value = (u.role && u.role.toLowerCase() === 'admin') ? 'admin' : 'client';
                    }
                }catch(e){ /* ignore */ }
            }
            modal.style.display = 'flex';
        }

        function closeAccountModal(){ modal.style.display = 'none'; editingEmail = null; }
        closeBtn.addEventListener('click', closeAccountModal);
        cancelBtn.addEventListener('click', closeAccountModal);
        if(createBtn) createBtn.addEventListener('click', function(){ openAccountModal('create'); });

        form.addEventListener('submit', function(e){
            e.preventDefault();
            var firstName = (document.getElementById('firstName_m').value||'').trim();
            var lastName = (document.getElementById('lastName_m').value||'').trim();
            var email = (document.getElementById('email_m').value||'').trim().toLowerCase();
            var phone = (document.getElementById('phone_m').value||'').trim();
            var password = (document.getElementById('password_m').value||'');
            var role = (document.getElementById('role_m').value||'client');
            if(!email){ alert('Please enter an email'); return; }
            try{
                var users = JSON.parse(localStorage.getItem('users')||'[]') || [];
                var existing = users.find(function(u){ return (u.email||'').toLowerCase() === email; });
                    if(currentMode === 'create'){
                        if(existing){ alert('A user with this email already exists'); return; }
                        var newUser = { email: email, password: password || '', firstName: firstName, lastName: lastName, phone: phone, role: (role === 'admin' ? 'admin' : 'user'), registeredAt: Date.now() };
                        users.push(newUser);
                    } else {
                        // When editing, locate the original record by the editingEmail (the original email before edits)
                        var originalEmail = (editingEmail ? decodeURIComponent(editingEmail) : null);
                        var idx = -1;
                        if(originalEmail){ idx = users.findIndex(function(u){ return (u.email||'').toLowerCase() === (originalEmail||'').toLowerCase(); }); }
                        // If we couldn't find by original email, fallback to finding by the submitted email
                        if(idx === -1){ idx = users.findIndex(function(u){ return (u.email||'').toLowerCase() === (email||'').toLowerCase(); }); }
                        if(idx === -1){ alert('User not found'); closeAccountModal(); return; }
                        // Ensure new email is not colliding with a different user
                        var collision = users.find(function(u, i){ return i !== idx && (u.email||'').toLowerCase() === (email||'').toLowerCase(); });
                        if(collision){ alert('Another user already uses that email'); return; }
                        var existingUser = users[idx];
                        existingUser.firstName = firstName || existingUser.firstName;
                        existingUser.lastName = lastName || existingUser.lastName;
                        existingUser.phone = phone || existingUser.phone;
                        if(password) existingUser.password = password;
                        existingUser.role = (role === 'admin') ? 'admin' : (existingUser.role || 'user');
                        // If email changed, update it
                        existingUser.email = email;
                    }
                localStorage.setItem('users', JSON.stringify(users));
                closeAccountModal();
                // refresh table
                try{ render(); }catch(e){}
            }catch(err){ console.warn('Could not save user', err); alert('Could not save user'); }
        });

        // delegate clicks for edit/delete in the table
        document.getElementById('accountsTbody').addEventListener('click', function(e){
            var editBtn = e.target.closest && e.target.closest('.edit-btn');
            if(editBtn){ var em = editBtn.getAttribute('data-email') || ''; openAccountModal('edit', em); return; }
            var delBtn = e.target.closest && e.target.closest('.delete-btn');
            if(delBtn){ var em2 = decodeURIComponent(delBtn.getAttribute('data-email')||''); if(confirm('Delete account ' + em2 + '? This cannot be undone.')){ try{ var users = JSON.parse(localStorage.getItem('users')||'[]')||[]; users = users.filter(function(u){ return (u.email||'').toLowerCase() !== (em2||'').toLowerCase(); }); localStorage.setItem('users', JSON.stringify(users)); try{ render(); }catch(e){} }catch(err){ console.warn('Delete failed', err); alert('Delete failed'); } } }
        });
    })();
    </script>

</body>
</html>
