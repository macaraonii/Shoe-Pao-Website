<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Account Detail</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        :root{--accent:#b71c1c;--muted:#666;--page-bg:#fafafa}
        body{font-family:'Poppins',Arial,sans-serif;margin:0;background:var(--page-bg);color:#222}
        .topbar{background:#fff;display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid #eee;position:sticky;top:0;z-index:50}
        .nav-left{display:flex;align-items:center;gap:22px;width:70%;max-width:820px}
        .nav-left-inner{display:flex;align-items:center;justify-content:space-between;width:100%}
        .logo-wrap{display:flex;align-items:center;gap:12px;text-decoration:none;color:inherit}
        .logo-wrap img{height:40px}
        .site-title{font-weight:600;color:var(--accent);font-size:1.05rem}
        .nav-item{font-size:0.98rem;font-weight:500;color:#222;cursor:pointer;text-decoration:none;padding:8px 12px;border-radius:6px}
        .nav-item:hover{color:var(--accent)}
        .nav-right{display:flex;align-items:center;gap:12px}
        .profile-btn{background:none;border:0;padding:6px;cursor:pointer}
        .profile-btn img{width:34px;height:34px}
    /* make detail page start at the very left of the viewport */
    .container{max-width:none;margin:28px 0;padding:0 !important;width:100%}
    /* override any site-container left padding for this page */
    .site-container{padding-left:0 !important; padding-right:0 !important}
    /* tighten grid gap so left card is visually at the leftmost position */
    .detail-grid{grid-template-columns:420px 1fr;gap:0;}
    /* ensure the profile card itself has no extra left margin; keep internal padding for fields */
    #profileColumn{margin-left:0;padding-left:22px}
    /* layout: left profile column, right orders column */
    .detail-grid{display:grid;grid-template-columns:420px 1fr;gap:28px;align-items:start}
    /* pin profile card slightly inset from viewport edges so it clears the nav and page border */
    /* increased left gutter (24px) and larger vertical spacing below the nav (120px) */
    /* keep the card content-sized (don't stretch to page bottom) and allow internal scrolling if content grows */
    #profileColumn{position:fixed;left:24px;top:120px;width:420px;z-index:40;max-height:calc(100vh - 160px);overflow:auto}
     /* position orders column visually next to the fixed profile card
         use relative left so it sits next to the card regardless of outer layout */
    /* bring orders column closer to the fixed profile card so they sit next to each other */
     /* position orders column immediately beside the fixed profile card (no gap)
         use fixed positioning so it aligns to the viewport like the profile card and
         doesn't get pushed down by surrounding flow */
    /* position the orders column fully to the right of the profile card so its leftmost text is not covered */
    /* move it a bit further right and keep a small inner padding for comfortable spacing */
     /* reduce the extra push and place a small gap (12px) to the right of the card;
        align vertically with the profile card (top:120px) */
     /* reduced horizontal gap further by 29% of the current gap
         current gap = 563 - 444 = 119px; new gap ≈ 84px -> left = 444 + 84 = 528px */
    #ordersColumn{position:fixed;left:528px;top:120px;padding-left:12px;width:calc(100% - 528px);max-width:calc(100% - 528px);z-index:30}
    .user-card{background:#fff;border:1px solid #eee;border-radius:10px;padding:22px}
    .profile-label{font-size:0.98rem;font-weight:600;margin-bottom:6px;color:#222}
    .profile-input{width:100%;font-size:1rem;padding:10px 12px;border-radius:8px;border:1px solid #eee;background:#fff;box-shadow:0 1px 4px rgba(34,34,34,0.04);box-sizing:border-box;max-width:100%;overflow-wrap:break-word}
    .profile-address-box{background:#f5f5f5;border-radius:10px;padding:12px 14px;margin:8px 0;color:#222;white-space:pre-line}
    .profile-field{margin-bottom:12px}
    .orders-list{display:flex;flex-direction:column;gap:12px}
    .order-card{background:#fff;border:1px solid #eee;border-radius:8px;padding:12px;display:flex;justify-content:space-between;align-items:center}

    /* Make order rows shorter (about 50% width) so they don't span the full orders column */
    .orders-list{align-items:flex-start}
    .order-card{width:50%;box-sizing:border-box}
    .muted{color:var(--muted)}
    @media (max-width:900px){
        .detail-grid{grid-template-columns:1fr; }
        /* restore normal flow on smaller screens */
        #profileColumn{position:static;width:auto}
        /* undo the fixed offsets for the orders column on small screens */
        #ordersColumn{position:static;left:auto;top:auto;margin-left:0;padding-left:initial;max-width:none;width:auto}
        .order-card{width:100%}
    }
    </style>
</head>
<body>
    <header class="topbar">
        <div class="nav-left">
            <div class="nav-left-inner">
                <a class="logo-wrap" href="dashboard.html" aria-label="Shoe Pao dashboard">
                    <img src="IMAGE/SHOEPAOLOGO.png" alt="ShoePao logo">
                    <span class="site-title">Shoe Pao Footwear</span>
                </a>
                <a class="nav-item" href="dashboard.html">OVERVIEW</a>
                <a class="nav-item" href="orders.html">Orders</a>
                <a class="nav-item" href="inventory.html">Inventory</a>
                <a class="nav-item" href="accounts.html">Accounts</a>
            </div>
        </div>
        <div class="nav-right">
            <button class="profile-btn" onclick="location.href='profile.html'" aria-label="Profile">
                <img src="IMAGE/USERICON.png" alt="User">
            </button>
        </div>
    </header>

    <main class="container">
        <div id="userWrap" class="detail-grid">
            <section class="user-card" id="profileColumn">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                            <div id="userNameTop" style="font-weight:700;font-size:1.2rem">Name</div>
                        </div>
                </div>

                <!-- Name moved to top heading; removed duplicate Name field -->

                <div class="profile-field">
                    <div class="profile-label">Email</div>
                    <input id="profileEmailField" class="profile-input" readonly />
                </div>

                <div class="profile-field">
                    <div class="profile-label">Address</div>
                    <div id="profileAddressField" class="profile-address-box" aria-readonly="true">EMPTY</div>
                </div>

                <div class="profile-field">
                    <div class="profile-label">Contact Number</div>
                    <input id="profilePhoneField" class="profile-input" readonly />
                </div>

                <div style="margin-top:12px;color:#444" id="userMeta"></div>
            </section>

            <section id="ordersColumn">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <div style="font-weight:700;font-size:1.1rem">Orders by this user</div>
                </div>
                <div id="userOrders" class="orders-list">
                    <!-- order rows inserted here -->
                </div>
            </section>
        </div>
    </main>

    <!-- Order Details Modal (copied from client-orders.html, simplified) -->
    <div id="orderModalOverlay" style="display:none;position:fixed;inset:0;background:rgba(34,34,34,0.45);z-index:9999;align-items:center;justify-content:center;">
        <div id="orderModal" style="background:#fff;border-radius:18px;box-shadow:0 8px 32px rgba(34,34,34,0.18);padding:28px;min-width:520px;max-width:96vw;">
            <div style="display:flex;align-items:center;justify-content:space-between;">
                <div style="font-size:1.2rem;font-weight:700;">Order Details</div>
                <button onclick="closeOrderModal()" style="background:none;border:none;cursor:pointer;"><img src="IMAGE/X.png" alt="Close" style="width:22px;height:22px;"></button>
            </div>
            <div style="height:1px;background:#eee;margin:14px 0;"></div>
            <div style="display:flex;gap:18px;align-items:flex-start;">
                <div style="flex:1;">
                    <div id="orderModalId" style="font-weight:600;margin-bottom:6px;"></div>
                    <div id="orderModalCustomer" style="margin-bottom:6px;font-weight:600;"></div>
                    <div id="orderModalName" style="margin-bottom:6px;color:#444;"></div>
                    <div id="orderModalEst" style="margin-bottom:6px;color:#444;"></div>
                    <div id="orderModalPayment" style="margin-bottom:6px;color:#444;"></div>
                    <div id="orderModalAddress" style="margin-bottom:6px;"></div>
                    <div id="orderModalRevocation" style="display:none;margin-top:6px;color:#b71c1c;font-weight:600;"></div>
                </div>
                <img id="orderModalImg" src="" alt="Product" style="width:160px;height:110px;object-fit:cover;border-radius:8px;">
            </div>
            <div style="margin-top:12px;font-weight:600;">Items</div>
            <div id="orderModalItems" style="margin-top:8px;"></div>
            <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <div id="orderModalStatus" style="font-weight:600;margin-bottom:6px;"></div>
                    <div id="orderModalDelivery" style="color:#444;font-size:0.95rem;margin-top:6px;"></div>
                </div>
                <div id="orderModalTotal" style="font-weight:700;"></div>
            </div>
        </div>
    </div>

    <script>
    (function(){
        function qs(name){
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }
        function getUsers(){ try{ return JSON.parse(localStorage.getItem('users') || '[]') }catch(e){ return [] } }
        function getOrders(){ try{ return JSON.parse(localStorage.getItem('orders') || '[]') }catch(e){ return [] } }
        function formatPHP(n){ return 'PHP ' + Number(n||0).toLocaleString(); }

        const email = qs('email');
        if(!email){ document.getElementById('userWrap').innerHTML = '<div class="user-card">No user specified.</div>'; }

        function render(){
            const users = getUsers();
            var userIndex = users.findIndex(u => (u.email||'').toLowerCase() === (email||'').toLowerCase());
            const user = userIndex !== -1 ? users[userIndex] : null;
            if(!user){ document.getElementById('userWrap').innerHTML = '<div class="user-card">User not found.</div>'; return; }
            // Prefer the user's `name` field; fall back to firstName + lastName. Do not pull from orders here.
            var displayName = (user.name && user.name.trim()) ? user.name.trim() : ((user.firstName ? (user.firstName + (user.lastName ? (' ' + user.lastName) : '')) : '') );
            if(!displayName || displayName.trim() === '') displayName = 'EMPTY';
            document.getElementById('userNameTop').textContent = displayName;
            document.getElementById('profileEmailField').value = user.email || 'EMPTY';
            document.getElementById('profilePhoneField').value = user.phone || 'EMPTY';
            // address: robust resolution across multiple possible shapes
            function extractAddressFrom(obj){
                if(!obj || typeof obj !== 'object') return '';
                // direct fields
                var parts = [];
                var v = obj.addressMain || obj.address_main || obj.address1 || obj.addressLine1 || obj.addressLine || obj.address || obj.fullAddress || obj.full_address || obj.shippingAddress || obj.shipping_address || obj.location || '';
                if(v && String(v).trim()) parts.push(String(v).trim());
                var v2 = obj.addressDetails || obj.address_details || obj.address2 || obj.addressLine2 || obj.addressDetails || '';
                if(v2 && String(v2).trim()) parts.push(String(v2).trim());
                // if object has addresses array
                if(parts.length === 0 && Array.isArray(obj.addresses) && obj.addresses.length){
                    var a = obj.addresses[0];
                    if(typeof a === 'string') return a;
                    if(a && typeof a === 'object'){
                        var ap = a.addressMain || a.address || a.fullAddress || a.line1 || a.line_1 || '';
                        var ap2 = a.addressDetails || a.line2 || a.line_2 || '';
                        var out = '';
                        if(ap) out += ap;
                        if(ap2) out += (out ? '\n' : '') + ap2;
                        if(out) return out;
                    }
                }
                return parts.join('\n');
            }

            // Only use the address stored on the user record (or nested user.profile).
            // Do NOT fall back to global profile, order shippingRegion, or any order-only fields.
            var addr = '';
            try{
                addr = extractAddressFrom(user) || '';
                if(!addr && user.profile) addr = extractAddressFrom(user.profile) || '';
            }catch(e){ addr = '' }
            var addrEl = document.getElementById('profileAddressField');
            if(addrEl){ addrEl.textContent = addr || 'EMPTY'; }
            var meta = '';
            if(user.registeredAt) meta += 'Registered: ' + new Date(user.registeredAt).toLocaleString() + ' ';
            if(user.lastLogin) meta += ' • Last login: ' + new Date(user.lastLogin).toLocaleString();
            document.getElementById('userMeta').textContent = meta;

            const orders = getOrders().filter(o => {
                // orders may store customer email under order.email, order.profile.email, or order.checkoutEmail
                const candidates = [o.email, (o.customerEmail||''), (o.checkoutEmail||''), (o.customerName||'')];
                // also check order.profile.email or order.profile
                if(o.profile && o.profile.email) candidates.push(o.profile.email);
                if(o.customer && o.customer.email) candidates.push(o.customer.email);
                if(o.customerName && o.customerName.indexOf('@') !== -1) candidates.push(o.customerName);
                return candidates.some(c => (c||'').toLowerCase() === (email||'').toLowerCase());
            });
            const wrap = document.getElementById('userOrders');
            wrap.innerHTML = '';
            if(!orders || orders.length === 0){ wrap.innerHTML = '<div class="empty">No orders for this user.</div>'; return; }
            orders.forEach(o => {
                const row = document.createElement('div'); row.className = 'order-card';
                const left = document.createElement('div'); left.style.flex = '1';
                left.innerHTML = '<div style="font-weight:700">Order ' + (o.id || '') + '</div><div class="muted">' + (new Date(o.date||o.createdAt||Date.now())).toLocaleString() + '</div>';
                const right = document.createElement('div'); right.style.textAlign = 'right'; right.innerHTML = '<div style="font-weight:700">' + formatPHP(o.total||o.subtotal||0) + '</div><div class="muted">' + (o.status||'') + '</div>';
                row.appendChild(left); row.appendChild(right);
                // open the order modal in-place (find full orders index and open modal)
                row.onclick = function(){
                    try{
                        const all = getOrders() || [];
                        const idx = all.findIndex(function(x){ return (x.id||'') === (o.id||''); });
                        if(idx !== -1 && window.openOrderModal){ window.openOrderModal(idx); }
                        else { window.location.href = 'client-orders.html?open=' + encodeURIComponent(o.id || ''); }
                    }catch(e){ window.location.href = 'client-orders.html?open=' + encodeURIComponent(o.id || ''); }
                };
                wrap.appendChild(row);
            });
        }

        document.addEventListener('DOMContentLoaded', render);
        window.addEventListener('storage', function(e){ if(e.key === 'users' || e.key === 'orders') render(); });

        // Impersonate removed for admin view
    })();

    // Order modal helpers (adapted from client-orders.html)
    (function(){
        function formatPHP(n){ return 'PHP ' + Number(n||0).toLocaleString(); }
        function titleCase(str){ if(!str && str !== 0) return ''; return String(str).split(/(\s+)/).map(token=>{ if(/\s+/.test(token)) return token; if(!/[a-zA-Z]/.test(token.charAt(0))) return token; return token.charAt(0).toUpperCase() + token.slice(1); }).join(''); }

        window.openOrderModal = function(idx){
            var orders = JSON.parse(localStorage.getItem('orders')||'[]');
            var order = orders[idx];
            if(!order) return;
            document.getElementById('orderModalId').textContent = 'Order ID: ' + order.id;
            var customerName = order.customerName || (JSON.parse(sessionStorage.getItem('profile')||localStorage.getItem('profile')||'{}').name) || localStorage.getItem('checkoutCustomerName') || '';
            document.getElementById('orderModalCustomer').textContent = customerName ? ('Customer: ' + customerName) : '';
            document.getElementById('orderModalName').textContent = 'Order Date: ' + new Date(order.date).toLocaleString();
            document.getElementById('orderModalEst').textContent = order.est ? ('Est. Delivery: ' + order.est) : '';
            var paymentLabel = order.paymentLabel || order.payment || '';
            if(!paymentLabel && order.paymentCode){ if(order.paymentCode === 'qr_ph') paymentLabel = 'QR PH'; else if(order.paymentCode === 'bank_transfer') paymentLabel = 'Bank Transfer'; else if(order.paymentCode === 'cod') paymentLabel = 'Cash on Delivery'; }
            document.getElementById('orderModalPayment').textContent = paymentLabel ? ('Payment: ' + paymentLabel) : '';
            var addrTxt = '';
            if(order.shippingAddress){ addrTxt += 'Ship to: ' + order.shippingAddress; }
            if(order.shippingRegion){ addrTxt += (addrTxt ? ' — ' : '') + 'Region: ' + order.shippingRegion; }
            if(order.tracking){ addrTxt += (addrTxt ? '\n' : '') + 'Tracking #: ' + order.tracking; }
            document.getElementById('orderModalAddress').textContent = addrTxt;
            var deliveryLabel = order.deliveryLabel || order.deliveryMethod || localStorage.getItem('checkoutDelivery') || '';
            if(!deliveryLabel && order.deliveryCode){ if(order.deliveryCode === 'personal') deliveryLabel = 'Personal Delivery'; else if(order.deliveryCode === 'lalamove') deliveryLabel = 'Lalamove'; else if(order.deliveryCode === 'jnt') deliveryLabel = 'J&T Express'; }
            document.getElementById('orderModalDelivery').textContent = deliveryLabel ? ('Delivery: ' + deliveryLabel) : '';
            document.getElementById('orderModalImg').src = (order.items[0] && order.items[0].image) || 'IMAGE/NIKE1.png';
            var itemsHtml = '';
            order.items.forEach(function(it){ var qty = it.quantity || it.qty || 1; itemsHtml += '<div style="margin-bottom:6px;">' + qty + ' x ' + (it.title||'Product') + ' — ' + formatPHP((it.price||0) * qty) + '</div>'; });
            document.getElementById('orderModalItems').innerHTML = itemsHtml;
            document.getElementById('orderModalStatus').textContent = 'Status: ' + titleCase(order.status);
            var ship = Number(order.shipping || 0);
            if(ship && ship > 0){ var shipLine = '<div style="margin-top:8px;color:#444;">Shipping: ' + formatPHP(ship) + '</div>'; document.getElementById('orderModalItems').insertAdjacentHTML('beforeend', shipLine); }
            document.getElementById('orderModalTotal').textContent = formatPHP(order.total || (order.subtotal + (order.shipping||0)));
            try{
                var revDiv = document.getElementById('orderModalRevocation');
                if(revDiv){ if(order.cancellation && order.cancellation.adminRevoked){ var rev = order.cancellation.revocation || order.cancellation.revocation || {}; var reasons = (rev.reasons && rev.reasons.length) ? rev.reasons : (order.cancellation.reasons || []); var ts = rev.timestamp || order.cancellation.revocation && order.cancellation.revocation.timestamp || ''; var html = '<div style="font-weight:700;color:#b71c1c;margin-top:6px;">Cancel Request Was Revoked</div>'; if(reasons && reasons.length){ html += '<div style="color:#444;font-weight:600;margin-top:6px;">Reason(s):</div><ul style="margin:6px 0 0 18px;color:#444;">'; reasons.forEach(function(r){ html += '<li>' + (r || '') + '</li>'; }); html += '</ul>'; } if(ts){ try{ html += '<div style="margin-top:6px;color:#666;font-size:0.9rem;">Revoked on: ' + new Date(ts).toLocaleString() + '</div>'; }catch(e){ html += '<div style="margin-top:6px;color:#666;font-size:0.9rem;">Revoked on: ' + ts + '</div>'; } } revDiv.innerHTML = html; revDiv.style.display = 'block'; } else { revDiv.innerHTML = ''; revDiv.style.display = 'none'; } }
            }catch(e){}
            document.getElementById('orderModalOverlay').style.display = 'flex'; document.body.style.overflow='hidden';
        }

        window.closeOrderModal = function(){ var el = document.getElementById('orderModalOverlay'); if(el) el.style.display = 'none'; document.body.style.overflow=''; }
    })();
    </script>
</body>
</html>
