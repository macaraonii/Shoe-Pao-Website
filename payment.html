<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - SHOEPAO</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .payment-left {
            flex: 2;
            padding: 0 40px 0 0;
            min-width: 420px;
        }
        .payment-main {
            display:flex;
            flex-direction:row;
            max-width:1200px;
            margin:0 auto;
            padding:32px 16px 0 16px; /* add spacing from left/right edges */
            box-sizing:border-box;
        }
        .payment-right {
            flex: 1.1;
            background: #f5f5f5;
            padding: 32px 32px 32px 32px;
            min-width: 340px;
            max-width: 400px;
            border-left: 1px solid #eee;
            display: flex;
            flex-direction: column;
            height: fit-content;
        }
        .payment-header {
            font-size: 2.1rem;
            font-weight: 600;
            margin-bottom: 24px;
            font-family: 'Poppins', Arial, sans-serif;
        }
        .payment-caption {
            font-size: 1.08rem;
            color: #222;
            margin-bottom: 18px;
            font-family: 'Poppins', Arial, sans-serif;
        }
        .payment-divider {
            width: 100%;
            height: 1.5px;
            background: #eee;
            margin: 18px 0 18px 0;
        }
        .payment-method-title {
            font-size: 1.08rem;
            font-weight: 500;
            margin-bottom: 8px;
            color: #222;
        }
        .payment-method-list {
            margin-bottom: 18px;
        }
        .payment-method-list ul {
            margin: 0 0 0 18px;
            padding: 0;
        }
        .payment-method-list li {
            font-size: 1rem;
            color: #444;
            margin-bottom: 4px;
            font-family: 'Poppins', Arial, sans-serif;
        }
        .payment-upload-title {
            font-size: 1.08rem;
            font-weight: 500;
            margin-bottom: 8px;
            color: #222;
        }
        .payment-upload-box {
            background: #fff;
            border-radius: 18px;
            padding: 18px 0;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #eee;
            font-size: 1.05rem;
            color: #222;
            cursor: pointer;
            font-family: 'Poppins', Arial, sans-serif;
            box-shadow: 0 1px 4px rgba(34,34,34,0.07);
        }
        .payment-btn-row {
            display: flex;
            justify-content: center;
            margin: 32px 0 18px 0;
        }
        .payment-placeorder-btn {
            background: #222;
            color: #fff;
            border: none;
            border-radius: 28px;
            padding: 16px 0;
            width: 100%;
            max-width: 340px;
            font-size: 1.15rem;
            font-family: 'Poppins', Arial, sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(34,34,34,0.10);
        }
        .payment-placeorder-btn:hover {
            background: #b71c1c;
            box-shadow: 0 4px 16px rgba(34,34,34,0.13);
        }
        .payment-policy-row {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 18px;
        }
        /* Bank details modal styling */
        .bank-modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:200000; }
        .bank-modal-overlay.show{ display:flex; }
        .bank-modal{ width:640px; max-width:calc(100vw - 48px); background:#fff; border-radius:12px; padding:20px; box-shadow:0 12px 48px rgba(0,0,0,0.28); font-family:'Poppins', Arial, sans-serif; }
        .bank-modal h3{ margin:0 0 8px 0; font-size:1.15rem; }
        .bank-modal .field-row{ display:flex; gap:10px; margin-top:10px; }
        .bank-modal .field{ flex:1; display:flex; flex-direction:column; }
        .bank-modal label{ font-size:0.95rem; color:#333; margin-bottom:6px; }
        .bank-modal input, .bank-modal select{ padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-size:1rem; }
        .bank-modal-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:14px; }
        .bank-modal .btn{ padding:10px 14px; border-radius:8px; border:none; cursor:pointer; }
        .bank-modal .btn.primary{ background:#222; color:#fff; }
        .bank-modal .btn.ghost{ background:#fff; border:1px solid #ddd; }
        .payment-policy-link {
            text-decoration: underline;
            color: #222;
            font-size: 0.97rem;
            cursor: pointer;
            font-family: 'Poppins', Arial, sans-serif;
        }
        /* Bank details inline field styling */
        #bankDetailsInline input,
        #bankDetailsInline select {
            padding: 12px 14px;
            border: 1px solid #d0d0d0;
            border-radius: 12px;
            font-size: 1rem;
            background: #fff;
            box-sizing: border-box;
            height: 44px;
        }
        #bankDetailsInline input[type="text"] { line-height: 1.2; }
        #bankDetailsInline label { margin-bottom: 6px; display: block; }
    /* spacing between bank details and upload proof header */
    #bankDetailsInline { margin-bottom: 18px; }
    /* space above upload proof section when shown (helps separate from QR or bank details) */
    #bankActions { margin-top: 18px; }
    .download-qr-btn { background:#222;color:#fff;border:none;border-radius:10px;padding:8px 12px;font-size:0.95rem;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.08); }
    .download-qr-btn:disabled { opacity:0.6; cursor:not-allowed; }
        /* Right side cart summary */
        .payment-cart-list {
            display: flex;
            flex-direction: column;
            gap: 18px;
            margin-bottom: 18px;
        }
        .payment-cart-item {
            display: flex;
            gap: 14px;
            align-items: flex-start;
        }
        .payment-cart-img {
            width: 68px;
            height: 68px;
            border-radius: 10px;
            object-fit: cover;
            background: #fff;
        }
        .payment-cart-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .payment-cart-title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .payment-cart-title {
            font-size: 1.05rem;
            font-weight: 500;
            color: #222;
        }
        .payment-cart-price {
            font-size: 1.05rem;
            font-weight: 600;
            color: #222;
        }
        .payment-cart-size {
            font-size: 0.97rem;
            color: #444;
        }
        .payment-cart-qty {
            font-size: 0.97rem;
            color: #444;
        }
        .payment-cart-divider {
            width: 100%;
            height: 1.5px;
            background: #ddd;
            margin: 18px 0 18px 0;
        }
        .payment-cart-summary-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.05rem;
            color: #222;
            margin-bottom: 8px;
        }
        .payment-cart-summary-label {
            font-weight: 400;
        }
        .payment-cart-summary-value {
            font-weight: 500;
        }
        .payment-cart-total-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.18rem;
            font-weight: 600;
            color: #222;
            margin-top: 8px;
        }
        .cart-items {
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            max-height: 340px;
            padding-right: 8px;
        }
        @media (max-width: 900px) {
            .payment-main {
                flex-direction: column;
                padding: 18px 0 0 0;
            }
            .payment-left, .payment-right {
                min-width: 0;
                max-width: 100vw;
                padding: 0 12px;
            }
            .payment-right {
                margin-top: 32px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar (copied from product-list.html) -->
    <nav class="homepage-header" style="position:sticky;top:0;z-index:100;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.04);padding:0 40px;display:flex;align-items:center;justify-content:space-between;height:72px;">
        <div style="display:flex;align-items:center;gap:24px;">
            <a href="home.html" style="display:flex;align-items:center;gap:24px;text-decoration:none;color:inherit;">
                <img src="IMAGE/SHOEPAOLOGO.png" alt="SHOEPAO Logo" style="height:38px;width:auto;cursor:pointer;">
                <span class="header-caption" style="font-size:1.18rem;font-weight:600;color:#b71c1c;cursor:pointer;">Shoe Pao Footwear</span>
            </a>
            <span class="header-link" onclick="goToSale()">Sale</span>
            <span class="header-link" onclick="goToNewArrivals()">New Arrivals</span>
            <span class="header-link" onclick="goToBrands()">Brands</span>
            <span class="header-link" onclick="goToProductList()">Shop All</span>
        </div>
        <div style="display:flex;align-items:center;gap:18px;">
            <button class="header-icon-btn" onclick="toggleSearchBox()" style="background:none;border:none;padding:6px;display:flex;align-items:center;cursor:pointer;"><img src="IMAGE/SEARCHICON.png" class="header-icon" alt="Search" style="width:26px;height:26px;"></button>
            <button class="header-icon-btn" onclick="goToUserPage()" style="background:none;border:none;padding:6px;display:flex;align-items:center;cursor:pointer;"><img src="IMAGE/USERICON.png" class="header-icon" alt="User" style="width:26px;height:26px;"></button>
            <button class="header-icon-btn" onclick="goToCartPage()" style="background:none;border:none;padding:6px;display:flex;align-items:center;cursor:pointer;"><img src="IMAGE/CARTICON.png" class="header-icon" alt="Cart" style="width:26px;height:26px;"></button>
        </div>
        <div class="search-box" id="searchBox" style="display:none;position:absolute;top:72px;right:80px;background:#fff;border:1px solid #ccc;border-radius:8px;padding:8px 16px;z-index:101;">
            <input type="text" class="search-input" id="searchInput" placeholder="Search products..." onkeydown="searchKeyDown(event)" style="font-family:'Poppins',Arial,sans-serif;font-size:1rem;border:none;outline:none;width:220px;padding:6px 0;">
        </div>
    </nav>
    <div class="payment-main">
        <div class="payment-left">
            <div class="payment-header">Payment</div>
            <div class="payment-caption">Payment should be done within 24 hours upon purchase. We will confirm your<br>order once we receive the payment.<br>Please upload proof of payment after transfer.<br>We accept BDO and BPI.</div>
            <div class="payment-method-list" style="margin-bottom:12px;">
                <!-- payment selection is chosen on the Checkout page but not shown here per design -->
            </div>
            <div id="qrInstructions" style="display:none;">
                <div class="payment-divider"></div>
                <div class="payment-method-title">QR PH Instructions</div>
                <div class="payment-method-list">
                    <ul>
                        <li>After placing the order you'll be redirected to QR PH to complete payment.</li>
                        <li>Scan the QR using your banking app (GCash, Maya, etc.) and keep the reference/receipt.</li>
                    </ul>
                </div>
                <div style="margin-top:12px;display:flex;flex-direction:column;align-items:center;gap:8px;">
                    <!-- QR image (place a QR file at IMAGE/QR_PH.png or update src as needed) -->
                    <img id="paymentQRImage" src="IMAGE/QR_PH.png" alt="QR PH" style="width:220px;height:220px;border-radius:12px;border:1px solid #eee;object-fit:contain;background:#fff;" data-attempt="" />
                    <div id="paymentQRFallback" style="font-size:0.95rem;color:#666;display:none;margin-top:8px;">QR image not available. Scan with your banking app or enter the reference number below.</div>
                    <div style="margin-top:8px;">
                        <button id="downloadPaymentQRBtn" class="download-qr-btn" type="button">Download QR</button>
                    </div>
                    <div style="font-size:0.98rem;color:#444;margin-top:8px;">Scan this QR code with your banking app to pay.</div>
                </div>
            </div>

            <div id="bankInstructions" style="display:none;">
                <div class="payment-divider"></div>
                <div class="payment-method-title">ðŸ’³ For Bank Transfer (BDO)</div>
                <div class="payment-method-list">
                    <ul>
                        <li>Bank Name: BDO Unibank, Inc.</li>
                        <li>Account Name: Paolo Pantua</li>
                        <li>Account Number: 0045 6789 1234</li>
                    </ul>
                </div>
                <div class="payment-method-title">ðŸ’³ For Bank Transfer (BPI)</div>
                <div class="payment-method-list">
                    <ul>
                        <li>Bank Name: Bank of the Philippine Islands (BPI)</li>
                        <li>Account Name: Paolo Pantua</li>
                        <li>Account Number: 1234 5678 90</li>
                    </ul>
                </div>
                <div class="payment-divider"></div>
            </div>

            <!-- Inline bank details (moved above upload/proof) -->
            <div id="bankDetailsInline" style="display:none;margin-top:14px;">
                <h3 style="margin:0 0 8px 0;font-size:1.05rem;">Bank Transfer Details</h3>
                <div style="font-size:0.95rem;color:#666;margin-bottom:8px;">Provide your bank details so we can verify the transfer if needed.</div>
                <div style="display:flex;gap:10px;margin-top:10px;">
                    <div style="flex:1;display:flex;flex-direction:column;">
                        <label for="bankSelect" style="font-size:0.95rem;color:#333;margin-bottom:6px;">Bank</label>
                        <select id="bankSelect"><option value="BDO">BDO</option><option value="BPI">BPI</option><option value="Other">Other</option></select>
                    </div>
                    <div style="flex:1;display:flex;flex-direction:column;">
                        <label for="acctTypeSelect" style="font-size:0.95rem;color:#333;margin-bottom:6px;">Account/Card Type</label>
                        <select id="acctTypeSelect"><option value="savings">Savings</option><option value="current">Current</option><option value="debit">Debit Card</option><option value="credit">Credit Card</option></select>
                    </div>
                </div>
                <div style="display:flex;gap:10px;margin-top:10px;">
                    <div style="flex:1;display:flex;flex-direction:column;">
                        <label for="acctNameInput" style="font-size:0.95rem;color:#333;margin-bottom:6px;">Account Name</label>
                        <input id="acctNameInput" type="text" placeholder="Account name" maxlength="30" />
                    </div>
                    <div style="flex:1;display:flex;flex-direction:column;">
                        <label for="acctNumberInput" style="font-size:0.95rem;color:#333;margin-bottom:6px;">Account Number</label>
                        <input id="acctNumberInput" type="text" placeholder="000000000000" maxlength="12" />
                    </div>
                </div>
                <div style="margin-top:10px;display:flex;gap:10px;">
                    <div style="flex:1;display:flex;flex-direction:column;">
                        <label for="bankNote" style="font-size:0.95rem;color:#333;margin-bottom:6px;">Notes (optional)</label>
                        <input id="bankNote" type="text" placeholder="e.g. branch or reference" maxlength="60" />
                    </div>
                </div>
                <!-- Auto-save on input/change; no Save/Cancel buttons per design -->
            </div>

            <div id="bankActions" style="display:none;">
                <h3 style="margin:0 0 8px 0;font-size:1.05rem;">Upload Proof of Payment Here</h3>
                <div class="payment-upload-box" id="uploadProofBtn">+ Upload Proof of Payment</div>
                <!-- hidden file input used to pick proof files -->
                <input id="uploadProofInput" type="file" accept="image/*,application/pdf" style="display:none;" />
                <div id="uploadPreview" style="margin-top:10px;display:none;align-items:center;gap:8px;">
                    <div id="uploadPreviewThumb" style="width:72px;height:72px;border-radius:8px;background:#fff;border:1px solid #eee;display:flex;align-items:center;justify-content:center;overflow:hidden;"></div>
                    <div style="flex:1;">
                        <div id="uploadPreviewName" style="font-size:0.98rem;color:#222;">Filename.pdf</div>
                        <div style="margin-top:6px;display:flex;gap:8px;align-items:center;">
                            <button id="removeProofBtn" class="btn ghost" style="padding:8px 10px;border-radius:8px;">Remove</button>
                        </div>
                    </div>
                </div>
                <div style="margin-top:12px;display:flex;gap:8px;align-items:center;">
                    <div style="flex:1;">
                        <label for="referenceNumber" style="display:block;font-size:0.98rem;color:#222;margin-bottom:6px;">Reference Number</label>
                        <input id="referenceNumber" type="text" placeholder="Enter reference number" style="width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:1rem;box-sizing:border-box;" />
                    </div>
                </div>
            </div>

            <div id="codInstructions" style="display:none;">
                <div class="payment-divider"></div>
                <div class="payment-method-title">Cash on Delivery</div>
                <div class="payment-method-list">
                    <ul>
                        <li>Pay the rider/delivery personnel upon receiving the package.</li>
                        <li>Please ensure the order details and package are correct before paying.</li>
                    </ul>
                </div>
            </div>
            <div class="payment-btn-row">
                <button class="payment-placeorder-btn" id="placeOrderBtn">Place order</button>
            </div>
            <div class="payment-policy-row">
                <span class="payment-policy-link">Refund policy</span>
                <span class="payment-policy-link">Shipping policy</span>
                <span class="payment-policy-link">Privacy Policy</span>
                <span class="payment-policy-link">Terms of Service</span>
                <span class="payment-policy-link">Contact Information</span>
            </div>
        </div>
        <div class="payment-right">
            <div class="payment-cart-list" id="paymentCartList">
                <!-- Cart items will be rendered here -->
            </div>
            <div class="payment-cart-divider"></div>
            <div class="payment-cart-summary-row">
                <span class="payment-cart-summary-label">Subtotal</span>
                <span class="payment-cart-summary-value" id="paymentSubtotal">â‚±0.00</span>
            </div>
            <div class="payment-cart-summary-row">
                <span class="payment-cart-summary-label">Packaging</span>
                <span class="payment-cart-summary-value" id="paymentPackagingValue">â‚±0.00</span>
            </div>
            <div class="payment-cart-summary-row" id="paymentShippingRow">
                <span class="payment-cart-summary-label" id="paymentShippingLabel">Shipping</span>
                <span class="payment-cart-summary-value" id="paymentShippingValue">â‚±0.00</span>
            </div>
            <div class="payment-cart-total-row">
                <span>Total</span>
                <span id="paymentTotal">â‚±0.00</span>
            </div>
        </div>
    </div>
    <script>
    // Navigation bar functions (copied from product-list.html)
    function goToSale() { window.location.href = 'product-list.html?sale=1'; }
    function goToNewArrivals() { window.location.href = 'product-list.html?new=1'; }
    function goToBrands() { window.location.href = 'product-list.html#brands'; }
    function goToProductList() { window.location.href = 'product-list.html'; }
    function goToUserPage() { window.location.href = 'profile.html'; }
    function goToCartPage() { window.location.href = 'cart.html'; }
    function toggleSearchBox() {
        var box = document.getElementById('searchBox');
        box.style.display = (box.style.display === 'block') ? 'none' : 'block';
        if (box.style.display === 'block') {
            document.getElementById('searchInput').focus();
        }
    }
    function searchKeyDown(e) {
        if (e.key === 'Enter') {
            var val = document.getElementById('searchInput').value.trim();
            if (val) {
                window.location.href = 'product-list.html?search=' + encodeURIComponent(val);
            }
        }
    }
    // Cart rendering
    function renderPaymentCart() {
        var cart = JSON.parse(localStorage.getItem('cart') || '[]');
        var cartList = document.getElementById('paymentCartList');
        var subtotal = 0;
        cartList.innerHTML = '';
        cart.forEach(function(item) {
            var qty = (typeof item.qty === 'number') ? item.qty : (typeof item.quantity === 'number' ? item.quantity : 1);
            var itemTotal = (item.price * qty);
            subtotal += itemTotal;
            var div = document.createElement('div');
            div.className = 'payment-cart-item';
            div.innerHTML = `
                <img src="${item.image}" class="payment-cart-img" alt="${item.title}">
                <div class="payment-cart-info">
                    <div class="payment-cart-title-row">
                        <span class="payment-cart-title">${item.title}</span>
                        <span class="payment-cart-price">â‚±${(item.price * qty).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</span>
                    </div>
                    <div class="payment-cart-size">Size: ${item.size}</div>
                    <div class="payment-cart-qty">QTY: ${qty}</div>
                </div>
            `;
            cartList.appendChild(div);
        });
        document.getElementById('paymentSubtotal').textContent = 'â‚±' + subtotal.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
        // read shipping price computed at checkout (if any)
        var shipping = Number(localStorage.getItem('checkoutShipping') || 0);
        var shippingLabel = localStorage.getItem('checkoutShippingLabel') || '';
        // ensure there's an element to show shipping (create if missing)
        var shipEl = document.getElementById('paymentShippingRow');
        if(!shipEl){
            shipEl = document.createElement('div');
            shipEl.id = 'paymentShippingRow';
            shipEl.style.display = 'flex'; shipEl.style.justifyContent = 'space-between'; shipEl.style.marginTop = '8px';
            shipEl.innerHTML = `<div class="payment-cart-summary-label" id="paymentShippingLabel">Shipping</div><div class="payment-cart-summary-value" id="paymentShippingValue">â‚±0.00</div>`;
            var rightCol = document.querySelector('.payment-right');
            if(rightCol){
                // insert shipping row before total row if possible
                var ref = document.getElementById('paymentTotalRow') || null;
                if(ref) ref.parentNode.insertBefore(shipEl, ref);
                else rightCol.appendChild(shipEl);
            }
        }
        document.getElementById('paymentShippingLabel').textContent = shippingLabel ? ('Shipping: ' + shippingLabel) : 'Shipping';
        document.getElementById('paymentShippingValue').textContent = 'â‚±' + shipping.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
        // Packaging fee is included in checkoutShipping for J&T â€” do not display packaging separately here
        try{
            var pkgEl = document.getElementById('paymentPackagingValue'); if(pkgEl) pkgEl.style.display = 'none';
            var pkgRow = document.getElementById('paymentPackagingRow'); if(pkgRow) pkgRow.style.display = 'none';
        }catch(e){}
        // Show total as subtotal + shipping (shipping already includes any packaging for J&T)
        document.getElementById('paymentTotal').textContent = 'â‚±' + (subtotal + shipping).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    }
    window.addEventListener('DOMContentLoaded', renderPaymentCart);

    // Helper: generate a QR image URL via public API for payment payloads
    function generatePaymentQRUrl(payload, size){
        try{
            size = Number(size) || 220;
            // keep payload short and non-sensitive; include timestamp if not provided
            if(!payload) payload = 'SHOEPAO:' + Date.now();
            return 'https://api.qrserver.com/v1/create-qr-code/?size=' + encodeURIComponent(size + 'x' + size) + '&data=' + encodeURIComponent(payload) + '&_=' + Date.now();
        }catch(e){ return '' }
    }

    // Download the currently-displayed payment QR image (handles data URLs and remote images)
    function downloadPaymentQR(){
        try{
            var img = document.getElementById('paymentQRImage');
            if(!img || !img.src) return alert('QR image not available yet.');
            var url = img.src;
            var btn = document.getElementById('downloadPaymentQRBtn');
            if(btn) { btn.disabled = true; btn.textContent = 'Downloading...'; }
            // If it's a data URL, trigger download directly
            if(url.indexOf('data:') === 0){
                var a = document.createElement('a'); a.href = url; a.download = 'shoe_pao_qr_' + Date.now() + '.png'; document.body.appendChild(a); a.click(); try{ a.remove(); }catch(e){}
                if(btn){ btn.disabled = false; btn.textContent = 'Download QR'; }
                return;
            }
            // Otherwise try fetching the image as blob (CORS may block this if server disallows)
            fetch(url, { mode: 'cors' }).then(function(res){ if(!res.ok) throw new Error('Failed to fetch'); return res.blob(); }).then(function(blob){
                var a = document.createElement('a');
                var objectUrl = URL.createObjectURL(blob);
                a.href = objectUrl;
                a.download = 'shoe_pao_qr_' + Date.now() + '.png';
                document.body.appendChild(a);
                a.click();
                setTimeout(function(){ URL.revokeObjectURL(objectUrl); try{ a.remove(); }catch(e){} }, 1500);
            }).catch(function(){
                // fallback: open in new tab so user can save manually
                try{ window.open(url, '_blank'); }catch(e){ alert('Unable to download QR.'); }
            }).finally(function(){ if(btn){ btn.disabled = false; btn.textContent = 'Download QR'; } });
        }catch(e){ if(document.getElementById('downloadPaymentQRBtn')){ document.getElementById('downloadPaymentQRBtn').disabled = false; document.getElementById('downloadPaymentQRBtn').textContent = 'Download QR'; } console.error('downloadPaymentQR error', e); alert('Unable to download QR.'); }
    }

        // Show/hide instruction blocks depending on chosen payment method
        document.addEventListener('DOMContentLoaded', function(){
            try{
                var code = (localStorage.getItem('checkoutPaymentCode') || '').toLowerCase();
                // normalize labels that might be stored instead of codes
                if(!code){ var lbl = (localStorage.getItem('checkoutPayment')||'').toLowerCase(); if(lbl.indexOf('qr')!==-1) code='qr_ph'; if(lbl.indexOf('bank')!==-1) code='bank_transfer'; if(lbl.indexOf('cash')!==-1) code='cod'; }
                var qrEl = document.getElementById('qrInstructions');
                var bankEl = document.getElementById('bankInstructions');
                var bankActions = document.getElementById('bankActions');
                // inline bank details section (replaces the old modal)
                var bankDetailsInline = document.getElementById('bankDetailsInline');
                var codEl = document.getElementById('codInstructions');
                // hide all first
                if(qrEl) qrEl.style.display = 'none';
                if(bankEl) bankEl.style.display = 'none';
                if(bankActions) bankActions.style.display = 'none';
                if(bankDetailsInline) bankDetailsInline.style.display = 'none';
                if(codEl) codEl.style.display = 'none';
                // show based on code
                if(code === 'qr_ph'){
                    if(qrEl) qrEl.style.display = '';
                    // also show upload + reference block (bankActions) so users can upload proof and enter ref for QR PH
                    if(bankActions) bankActions.style.display = '';
                        // Attempt to load a QR image data/url saved in localStorage (checkoutQR).
                        // If none exists, generate a QR image URL via public QR API to avoid 404 when the static
                        // `IMAGE/QR_PH.png` file is missing on the server.
                        try{
                            var qrImg = document.getElementById('paymentQRImage');
                            var storedQR = localStorage.getItem('checkoutQR');
                            if(qrImg){
                                if(storedQR){
                                    qrImg.src = storedQR;
                                } else {
                                    // generate a short, non-sensitive payload for the QR
                                    var payload = localStorage.getItem('checkoutPaymentPayload') || ('SHOEPAO:' + Date.now());
                                    var generated = generatePaymentQRUrl(payload, 240);
                                    if(generated) qrImg.src = generated;
                                }
                                qrImg.style.display = '';
                                // on error, attempt a packaged image once; otherwise show the fallback message
                                qrImg.onerror = function(){
                                    try{
                                        if(!qrImg.dataset.attempt || qrImg.dataset.attempt === ''){
                                            qrImg.dataset.attempt = 'fallback';
                                            qrImg.src = 'IMAGE/QR_PH.png';
                                        } else {
                                            qrImg.style.display = 'none';
                                            var fb = document.getElementById('paymentQRFallback'); if(fb) fb.style.display = 'block';
                                        }
                                    }catch(e){}
                                };
                            }
                        }catch(e){}
                } else if(code === 'bank_transfer'){
                    if(bankEl) bankEl.style.display = '';
                    if(bankActions) bankActions.style.display = '';
                    if(bankDetailsInline) bankDetailsInline.style.display = '';
                } else if(code === 'cod'){
                    if(codEl) codEl.style.display = '';
                }
                // Reference number constraints (GCash QR vs Bank Transfer)
                try{ updateReferenceFieldConstraints(code); }catch(e){}
            }catch(e){ /* ignore */ }
        });

        // Update referenceNumber input placeholder and maxlength based on payment method code
        function updateReferenceFieldConstraints(code){
            try{
                var ref = document.getElementById('referenceNumber');
                if(!ref) return;
                code = (code||'').toString().toLowerCase();
                // helper to sanitize input: remove non-digit characters
                function sanitizeDigits(v, max){ v = v.toString().replace(/\D/g,''); if(max) v = v.slice(0, max); return v; }
                // also apply similar formatting/validation to bank/account fields when present
                var acctNumEl = document.getElementById('acctNumberInput');
                var acctNameEl = document.getElementById('acctNameInput');
                function removeHandler(el, prop){ try{ if(el && el[prop]) el.removeEventListener('input', el[prop]); }catch(e){} }
                function setDigitHandler(el, max){ if(!el) return; removeHandler(el, '_acctHandler'); el._acctHandler = function(){ this.value = sanitizeDigits(this.value, max); }; el.addEventListener('input', el._acctHandler); }

                if(code === 'qr_ph'){
                    // QR PH (commonly GCash/Maya): reference numbers are usually 9 digits for GCash
                    ref.setAttribute('placeholder','000000000');
                    ref.setAttribute('maxlength','9');
                    // keep only digits and enforce length
                    ref.value = sanitizeDigits(ref.value, 9);
                    // attach input handler to enforce numeric-only and maxlength
                    ref.removeEventListener('input', ref._refHandler || function(){});
                    ref._refHandler = function(){ this.value = sanitizeDigits(this.value, 9); };
                    ref.addEventListener('input', ref._refHandler);
                    // remove any special handlers from acct fields
                    if(acctNumEl){ acctNumEl.setAttribute('placeholder','Account / Card number'); acctNumEl.setAttribute('maxlength','30'); removeHandler(acctNumEl, '_acctHandler'); }
                    if(acctNameEl){ acctNameEl.setAttribute('placeholder','Account name'); acctNameEl.setAttribute('maxlength','60'); removeHandler(acctNameEl, '_acctHandler'); }
                } else if(code === 'bank_transfer'){
                    // Bank transfer reference/account numbers (14 characters suggested)
                    ref.setAttribute('placeholder','00000000000000');
                    ref.setAttribute('maxlength','14');
                    // allow digits only (trim to 14)
                    ref.value = sanitizeDigits(ref.value, 14);
                    ref.removeEventListener('input', ref._refHandler || function(){});
                    ref._refHandler = function(){ this.value = sanitizeDigits(this.value, 14); };
                    ref.addEventListener('input', ref._refHandler);
                    // account number: numeric-only up to 14
                    if(acctNumEl){ acctNumEl.setAttribute('placeholder','000000000000'); acctNumEl.setAttribute('maxlength','12'); acctNumEl.value = sanitizeDigits(acctNumEl.value, 12); setDigitHandler(acctNumEl, 12); }
                    // account name: free text but limited length
                    if(acctNameEl){ acctNameEl.setAttribute('placeholder','Account name'); acctNameEl.setAttribute('maxlength','30'); removeHandler(acctNameEl, '_acctHandler'); acctNameEl.addEventListener('input', function(){ if(this.value && this.value.length>30) this.value = this.value.slice(0,30); }); }
                } else {
                    // default: allow alphanumeric up to 30
                    ref.setAttribute('placeholder','Enter reference number');
                    ref.setAttribute('maxlength','30');
                    // remove numeric-only handler if present
                    ref.removeEventListener('input', ref._refHandler || function(){});
                    ref._refHandler = null;
                    // reset acct fields to default lengths
                    if(acctNumEl){ acctNumEl.setAttribute('placeholder','Account / Card number'); acctNumEl.setAttribute('maxlength','30'); removeHandler(acctNumEl, '_acctHandler'); }
                    if(acctNameEl){ acctNameEl.setAttribute('placeholder','Account name'); acctNameEl.setAttribute('maxlength','60'); removeHandler(acctNameEl, '_acctHandler'); }
                }
            }catch(err){ console.error('updateReferenceFieldConstraints error', err); }
        }

        // Listen for storage events so if payment selection changes elsewhere we update the field
        window.addEventListener('storage', function(e){
            if(e.key === 'checkoutPaymentCode' || e.key === 'checkoutPayment'){
                var code = (localStorage.getItem('checkoutPaymentCode') || '').toLowerCase();
                if(!code){ var lbl = (localStorage.getItem('checkoutPayment')||'').toLowerCase(); if(lbl.indexOf('qr')!==-1) code='qr_ph'; if(lbl.indexOf('bank')!==-1) code='bank_transfer'; if(lbl.indexOf('cash')!==-1) code='cod'; }
                try{ 
                    // update constraints
                    updateReferenceFieldConstraints(code);
                    // also show/hide the visible blocks in case payment selection changed in another tab
                    var qrEl = document.getElementById('qrInstructions');
                    var bankEl = document.getElementById('bankInstructions');
                    var bankActions = document.getElementById('bankActions');
                    var bankDetailsInline = document.getElementById('bankDetailsInline');
                    var codEl = document.getElementById('codInstructions');
                    if(qrEl) qrEl.style.display = 'none';
                    if(bankEl) bankEl.style.display = 'none';
                    if(bankActions) bankActions.style.display = 'none';
                    if(bankDetailsInline) bankDetailsInline.style.display = 'none';
                    if(codEl) codEl.style.display = 'none';
                    if(code === 'qr_ph'){
                        if(qrEl) qrEl.style.display = '';
                        if(bankActions) bankActions.style.display = '';
                        // ensure qr image uses stored data if available and reset any fallback message
                        try{
                            var qrImg = document.getElementById('paymentQRImage');
                            var storedQR = localStorage.getItem('checkoutQR');
                            var fb = document.getElementById('paymentQRFallback'); if(fb) fb.style.display = 'none';
                            if(qrImg){
                                qrImg.dataset.attempt = '';
                                if(storedQR){ qrImg.src = storedQR; }
                                else { var payload = localStorage.getItem('checkoutPaymentPayload') || ('SHOEPAO:' + Date.now()); qrImg.src = generatePaymentQRUrl(payload, 240); }
                                qrImg.style.display = '';
                            }
                        }catch(e){}
                    } else if(code === 'bank_transfer'){
                        if(bankEl) bankEl.style.display = '';
                        if(bankActions) bankActions.style.display = '';
                        if(bankDetailsInline) bankDetailsInline.style.display = '';
                    } else if(code === 'cod'){
                        if(codEl) codEl.style.display = '';
                    }
                }catch(e){}
            }
        });

    // Place order: persist cart into orders[] and clear cart
    function generateOrderId() {
        var d = new Date();
        return 'ORD' + d.getFullYear().toString().slice(-2) + Math.floor(Math.random()*900000 + 100000);
    }
    function generateTracking() {
        return 'TR' + Math.floor(Math.random()*90000000 + 10000000);
    }
    function placeOrder() {
        var cart = JSON.parse(localStorage.getItem('cart') || '[]');
        if (!cart || cart.length === 0) {
            alert('Your cart is empty.');
            return;
        }
        var subtotal = 0;
        var items = cart.map(function(it){
            var qty = (typeof it.qty === 'number') ? it.qty : (typeof it.quantity === 'number' ? it.quantity : 1);
            subtotal += it.price * qty;
            return Object.assign({}, it, { quantity: qty });
        });
        // determine selected payment method code & label - prefer checkout selection stored in localStorage
        var selectedPaymentCode = localStorage.getItem('checkoutPaymentCode') || '';
        // if there's no checkout selection (legacy), try to read any on-page radios
        if(!selectedPaymentCode){
            var radios = document.querySelectorAll('input[name="paymentMethod"]');
            radios.forEach(function(r){ if(r.checked){ selectedPaymentCode = r.value || selectedPaymentCode; } });
        }
        // normalize selectedPaymentCode in case legacy labels were used
        function normalizePaymentCode(codeOrLabel){
            if(!codeOrLabel) return '';
            var s = String(codeOrLabel).toLowerCase();
            if(s === 'qr_ph' || s.indexOf('qr') !== -1 || s.indexOf('scan') !== -1) return 'qr_ph';
            if(s === 'bank_transfer' || s.indexOf('bank') !== -1) return 'bank_transfer';
            if(s === 'cod' || s.indexOf('cash') !== -1 || s.indexOf('cash on delivery') !== -1) return 'cod';
            return codeOrLabel;
        }
        selectedPaymentCode = normalizePaymentCode(selectedPaymentCode);
    // bank selection: prefer checkout-stored bank (if previously saved), else read any on-page bank choice
    var bankChoice = localStorage.getItem('checkoutBank') || '';
    if(!bankChoice){ bankChoice = (document.querySelector('input[name="bankChoice"]:checked')||{}).value || ''; }
        // map code -> human label
        function mapPaymentLabel(code, bank){
            var c = normalizePaymentCode(code);
            if(!c) return (localStorage.getItem('checkoutPayment')||'');
            if(c === 'qr_ph') return 'QR PH';
            if(c === 'bank_transfer') return bank ? ('Bank Transfer ('+bank+')') : 'Bank Transfer';
            if(c === 'cod') return 'Cash on Delivery';
            return code;
        }
    var selectedPaymentLabel = mapPaymentLabel(selectedPaymentCode, bankChoice);
        // delivery method from checkout (persisted earlier) - both code and label
        var deliveryCode = localStorage.getItem('checkoutDeliveryCode') || '';
        var deliveryLabel = localStorage.getItem('checkoutDelivery') || '';
    // try to read customer name from saved profile, otherwise from checkout
    var profile = JSON.parse(localStorage.getItem('profile') || '{}');
    var customerName = (profile && profile.name) ? profile.name : (localStorage.getItem('checkoutCustomerName') || '');
        var shippingCost = Number(localStorage.getItem('checkoutShipping') || 0);
        // packaging is already included in shippingCost for J&T; do not add it again to the order total
        var packagingCost = 0;
        var shippingAddress = (localStorage.getItem('checkoutAddressMain') || '').trim();
        if(!shippingAddress){
            // fallback to profile
            var profile = JSON.parse(localStorage.getItem('profile') || '{}');
            if(profile && (profile.addressMain || profile.addressDetails)){
                shippingAddress = (profile.addressMain || '') + (profile.addressDetails ? (', ' + profile.addressDetails) : '');
            }
        }
        var shippingRegion = (localStorage.getItem('checkoutRegion') || '').trim();

        var order = {
            id: generateOrderId(),
            tracking: generateTracking(),
            date: new Date().toISOString(),
            status: 'Pending',
            items: items,
            subtotal: subtotal,
            packaging: packagingCost,
            shipping: shippingCost,
            total: subtotal + shippingCost,
            paymentCode: selectedPaymentCode,
            paymentLabel: selectedPaymentLabel,
            referenceNumber: (document.getElementById('referenceNumber') ? document.getElementById('referenceNumber').value : ''),
            customerName: customerName,
            deliveryCode: deliveryCode,
            deliveryLabel: deliveryLabel,
            deliveryMethod: deliveryLabel
        };
        // attach the shipping address & region to the order (saved with order only)
        if(shippingAddress) order.shippingAddress = shippingAddress;
        if(shippingRegion) order.shippingRegion = shippingRegion;
        var orders = JSON.parse(localStorage.getItem('orders') || '[]');
        // Before saving the order, decrement inventory counts for purchased items
        // Also collect any inventory-level estimated delivery values (invRow.est) to attach to the order
        try {
            var inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
            var estSet = new Set();
            if (Array.isArray(inventory) && inventory.length) {
                items.forEach(function(it){
                    try {
                        var qty = Number(it.quantity || it.qty || 0);
                        var size = (it.size || '').toString();
                        // find matching inventory row by id/name/brand
                        var invRow = null;
                        if (it.id) invRow = inventory.find(function(r){ return r.id === it.id; });
                        if(!invRow) invRow = inventory.find(function(r){ return (r.name||'').toString().trim() === (it.title||'').toString().trim(); });
                        if(!invRow) invRow = inventory.find(function(r){ return (r.name||'').toString().toLowerCase().indexOf((it.title||'').toString().toLowerCase()) !== -1; });
                        if(!invRow && it.brand) invRow = inventory.find(function(r){ return (r.brand||'').toString().toLowerCase() === (it.brand||'').toString().toLowerCase(); });
                        // collect est if present on inventory row
                        if(invRow && invRow.est){ try{ var v = (invRow.est||'').toString().trim(); if(v) estSet.add(v); }catch(e){}
                        }
                        if (invRow && invRow.sizes && size) {
                            var currentStock = Number(invRow.sizes[size] || 0);
                            var newStock = currentStock - qty;
                            if (isNaN(newStock) || newStock < 0) newStock = 0;
                            invRow.sizes[size] = newStock;
                        }
                    } catch(e) { }
                });
                localStorage.setItem('inventory', JSON.stringify(inventory));
            }
            // attach inventory-est to order if any values collected
            try{
                var estArr = Array.from(estSet);
                if(estArr.length === 1){ order.est = estArr[0]; }
                else if(estArr.length > 1){ order.est = estArr.join(' â€¢ '); }
            }catch(e){}
        } catch (e) { /* ignore inventory update errors */ }

        orders.push(order);
        localStorage.setItem('orders', JSON.stringify(orders));
        // clear one-time checkout-only fields so address/region are stored only on the order
        try{
            localStorage.removeItem('checkoutAddressMain');
            localStorage.removeItem('checkoutRegion');
            localStorage.removeItem('checkoutShipping');
            localStorage.removeItem('checkoutShippingLabel');
            localStorage.removeItem('checkoutPackaging');
            // also clear delivery/payment transient keys
            localStorage.removeItem('checkoutDelivery');
            localStorage.removeItem('checkoutDeliveryCode');
            localStorage.removeItem('checkoutPayment');
            localStorage.removeItem('checkoutPaymentCode');
            localStorage.removeItem('checkoutCustomerName');
            localStorage.removeItem('checkoutBank');
        }catch(e){}
        // clear cart
        localStorage.setItem('cart', JSON.stringify([]));
        // navigate to client orders page
        window.location.href = 'client-orders.html';
    }
    document.addEventListener('DOMContentLoaded', function(){
        var btn = document.getElementById('placeOrderBtn');
        if (btn) btn.addEventListener('click', placeOrder);
        // Populate payment summary from Checkout selections
        try{
            var checkoutPaymentCode = localStorage.getItem('checkoutPaymentCode') || '';
            var checkoutPaymentLabel = localStorage.getItem('checkoutPayment') || '';
            var checkoutBank = localStorage.getItem('checkoutBank') || '';
            var labelEl = document.getElementById('paymentMethodLabel');
            var bankEl = document.getElementById('paymentMethodBank');
            if(labelEl){
                var displayLabel = checkoutPaymentLabel || (checkoutPaymentCode ? (checkoutPaymentCode === 'qr_ph' ? 'QR PH' : (checkoutPaymentCode === 'bank_transfer' ? 'Bank Transfer' : (checkoutPaymentCode === 'cod' ? 'Cash on Delivery' : checkoutPaymentCode))) : '(not chosen)');
                labelEl.textContent = 'Payment: ' + displayLabel;
            }
            if(bankEl){
                if(checkoutBank){ bankEl.style.display = 'block'; bankEl.textContent = 'Bank: ' + checkoutBank; }
                else { bankEl.style.display = 'none'; }
            }
        }catch(e){}
    });
    </script>
    <!-- Inline bank details (shown on payment page when Bank Transfer is selected) -->
    
    <script src="cart-storage.js"></script>
    <!-- ===== Cart Overlay + Sidebar HTML (universal) ===== -->
    <div id="cartOverlay" class="cart-overlay" aria-hidden="true"></div>
    <aside id="cartSidebar" class="cart-sidebar" aria-hidden="true" role="complementary">
        <div class="cart-header-row">
            <div>
                <span class="cart-header-title">Cart (<span id="cartCount">0</span>)</span>
            </div>
            <button id="closeCartBtn" class="cart-close" aria-label="Close cart"><img src="IMAGE/X.png" alt="Close" style="width:20px;height:20px;"></button>
        </div>
        <div class="cart-divider"></div>
        <div id="cartItems" class="cart-items">
            <div class="cart-empty">Your cart is empty</div>
        </div>
        <div class="cart-divider"></div>
        <div class="cart-subtotal-row">
            <span class="cart-subtotal-label">Subtotal</span>
            <span id="cartSubtotal" class="cart-subtotal-value">â‚±0.00</span>
        </div>
        <button id="checkoutBtn" class="cart-checkout-btn">Checkout</button>
    </aside>
    <!-- ===== Cart Sidebar Behavior (universal) ===== -->
    <script>
    (function(){
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        function parsePriceToNumber(priceText) {
            if (!priceText) return 0;
            var v = priceText.replace(/[^0-9.]/g, '');
            return parseFloat(v || 0);
        }
        function formatPHP(amount) {
            try {
                return new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(amount);
            } catch (e) {
                return 'â‚±' + Number(amount).toFixed(2);
            }
        }
        function saveCartToLocalStorage() {
            localStorage.setItem('cart', JSON.stringify(cart));
        }
        const cartOverlay = document.getElementById('cartOverlay');
        const cartSidebar = document.getElementById('cartSidebar');
        const cartItemsContainer = document.getElementById('cartItems');
        const cartCountEl = document.getElementById('cartCount');
        const cartSubtotalEl = document.getElementById('cartSubtotal');
        const closeCartBtn = document.getElementById('closeCartBtn');
        const checkoutBtn = document.getElementById('checkoutBtn');
        function getNavCartButton() {
            const img = document.querySelector('img[alt="Cart"]');
            if (!img) return null;
            return img.closest('button');
        }
        function openCartSidebar() {
            cartOverlay.classList.add('show');
            cartSidebar.classList.add('open');
            document.body.style.overflow = 'hidden';
            cartSidebar.setAttribute('aria-hidden', 'false');
            cartOverlay.setAttribute('aria-hidden', 'false');
        }
        function closeCartSidebar() {
            cartOverlay.classList.remove('show');
            cartSidebar.classList.remove('open');
            document.body.style.overflow = '';
            cartSidebar.setAttribute('aria-hidden', 'true');
            cartOverlay.setAttribute('aria-hidden', 'true');
        }
        function renderCart() {
            cartItemsContainer.innerHTML = '';
            if (cart.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'cart-empty';
                empty.textContent = 'Your cart is empty';
                cartItemsContainer.appendChild(empty);
                cartCountEl.textContent = 0;
                cartSubtotalEl.textContent = formatPHP(0);
                saveCartToLocalStorage();
                return;
            }
            let subtotal = 0;
            let totalQty = 0;
            cart.forEach((item, index) => {
                subtotal += item.price * item.quantity;
                totalQty += item.quantity;
                const box = document.createElement('div');
                box.className = 'cart-item-box';
                const img = document.createElement('img');
                img.className = 'cart-item-img';
                img.src = item.image || 'IMAGE/NIKE1.png';
                img.alt = item.title || 'Product';
                const middle = document.createElement('div');
                middle.className = 'cart-item-middle';
                const title = document.createElement('div');
                title.className = 'cart-item-title';
                title.textContent = item.title;
                const brand = document.createElement('div');
                brand.className = 'cart-item-brand';
                brand.textContent = item.brand;
                const size = document.createElement('div');
                size.className = 'cart-item-size';
                size.textContent = 'Size: ' + (item.size || '');
                const qtyControls = document.createElement('div');
                qtyControls.className = 'cart-quantity-controls';
                const lessenBtn = document.createElement('button');
                lessenBtn.className = 'qty-btn decrease';
                lessenBtn.setAttribute('data-index', index);
                const lessenImg = document.createElement('img');
                lessenImg.src = 'IMAGE/LessenBTN.png';
                lessenImg.alt = '-';
                lessenImg.style.width = '22px';
                lessenImg.style.height = '22px';
                lessenBtn.appendChild(lessenImg);
                const qtyText = document.createElement('span');
                qtyText.className = 'cart-item-qty';
                qtyText.textContent = item.quantity;
                const addBtn = document.createElement('button');
                addBtn.className = 'qty-btn increase';
                addBtn.setAttribute('data-index', index);
                const addImg = document.createElement('img');
                addImg.src = 'IMAGE/AddBTN.png';
                addImg.alt = '+';
                addImg.style.width = '22px';
                addImg.style.height = '22px';
                addBtn.appendChild(addImg);
                qtyControls.appendChild(lessenBtn);
                qtyControls.appendChild(qtyText);
                qtyControls.appendChild(addBtn);
                middle.appendChild(title);
                middle.appendChild(brand);
                middle.appendChild(size);
                middle.appendChild(qtyControls);
                const removeBtn = document.createElement('button');
                removeBtn.className = 'cart-item-remove';
                removeBtn.setAttribute('data-index', index);
                const trashImg = document.createElement('img');
                trashImg.src = 'IMAGE/TrashIcon.png';
                trashImg.alt = 'Remove';
                trashImg.style.width = '18px';
                trashImg.style.height = '18px';
                removeBtn.appendChild(trashImg);
                const priceEl = document.createElement('div');
                priceEl.className = 'cart-item-price';
                priceEl.textContent = formatPHP(item.price * item.quantity);
                box.appendChild(img);
                box.appendChild(middle);
                box.appendChild(removeBtn);
                box.appendChild(priceEl);
                cartItemsContainer.appendChild(box);
            });
            cartCountEl.textContent = totalQty;
            cartSubtotalEl.textContent = formatPHP(subtotal);
            attachCartEvents();
        }
        function attachCartEvents() {
            document.querySelectorAll('.qty-btn.decrease').forEach(btn => {
                btn.onclick = function(e) {
                    const idx = parseInt(btn.getAttribute('data-index'), 10);
                    if (!isNaN(idx) && cart[idx]) {
                        if (cart[idx].quantity > 1) {
                            cart[idx].quantity--;
                        }
                        renderCart();
                        saveCartToLocalStorage();
                    }
                };
            });
            document.querySelectorAll('.qty-btn.increase').forEach(btn => {
                btn.onclick = function(e) {
                    const idx = parseInt(btn.getAttribute('data-index'), 10);
                    if (!isNaN(idx) && cart[idx]) {
                            try {
                                var item = cart[idx];
                                var current = Number(item.quantity || 0);
                                var maxAllowed = (window.getMaxAllowedForProduct && typeof window.getMaxAllowedForProduct === 'function') ? window.getMaxAllowedForProduct(item) : 3;
                                if (current >= maxAllowed) {
                                    alert('Limit reached: you can only buy up to ' + maxAllowed + ' of this size.');
                                    return;
                                }
                                cart[idx].quantity++;
                            } catch (err) {
                                cart[idx].quantity++;
                            }
                            renderCart();
                            saveCartToLocalStorage();
                    }
                };
            });
            document.querySelectorAll('.cart-item-remove').forEach(btn => {
                btn.onclick = function(e) {
                    const idx = parseInt(btn.getAttribute('data-index'), 10);
                    if (!isNaN(idx)) {
                        cart.splice(idx, 1);
                        renderCart();
                        saveCartToLocalStorage();
                    }
                };
            });
        }
        document.addEventListener('DOMContentLoaded', function() {
            const navCartBtn = getNavCartButton();
            if (navCartBtn) {
                navCartBtn.removeAttribute('onclick');
                navCartBtn.addEventListener('click', function(e){
                    e.preventDefault();
                    openCartSidebar();
                });
            }
            if (closeCartBtn) closeCartBtn.addEventListener('click', closeCartSidebar);
            if (cartOverlay) cartOverlay.addEventListener('click', closeCartSidebar);
            renderCart();
            if (checkoutBtn) {
                checkoutBtn.addEventListener('click', function(){
                    window.location.href = 'checkout.html';
                });
            }
        });

        // Open bank modal when the payment summary is clicked and the selected method is bank_transfer
        document.addEventListener('DOMContentLoaded', function(){
            try{
                var pmSummary = document.getElementById('paymentMethodSummary');
                if(pmSummary){
                    pmSummary.style.cursor = 'pointer';
                    pmSummary.addEventListener('click', function(e){
                        e.preventDefault();
                        var code = (localStorage.getItem('checkoutPaymentCode') || '').toLowerCase();
                        if(!code){ var lbl = (localStorage.getItem('checkoutPayment')||'').toLowerCase(); if(lbl.indexOf('bank') !== -1) code = 'bank_transfer'; }
                        if(code === 'bank_transfer'){
                            // open the modal
                            if(typeof openBankModal === 'function') openBankModal();
                        }
                    });
                }
                // also make the small bank label clickable
                var bankLabel = document.getElementById('paymentMethodBank');
                if(bankLabel){ bankLabel.style.cursor = 'pointer'; bankLabel.addEventListener('click', function(){ if(typeof openBankModal === 'function') openBankModal(); }); }
            }catch(e){/* ignore */}
        });
    })();
    </script>
        <script>
        // Bank details inline behavior
        function openBankModal(){
            // show inline bank details instead of a modal
            var el = document.getElementById('bankDetailsInline');
            if(!el) return;
            // preload saved values into the fields
            try{
                var sel = document.getElementById('bankSelect'); if(sel && localStorage.getItem('checkoutBank')) sel.value = localStorage.getItem('checkoutBank');
                var at = document.getElementById('acctTypeSelect'); if(at && localStorage.getItem('checkoutBankAcctType')) at.value = localStorage.getItem('checkoutBankAcctType');
                var an = document.getElementById('acctNameInput'); if(an) an.value = localStorage.getItem('checkoutBankAcctName') || '';
                var anum = document.getElementById('acctNumberInput'); if(anum) anum.value = localStorage.getItem('checkoutBankAcctNumber') || '';
                var note = document.getElementById('bankNote'); if(note) note.value = localStorage.getItem('checkoutBankNote') || '';
            }catch(e){}
            el.style.display = '';
            try{ el.scrollIntoView({behavior:'smooth', block:'center'}); }catch(e){}
        }
        function closeBankModal(){ var el = document.getElementById('bankDetailsInline'); if(!el) return; el.style.display = 'none'; }
        document.addEventListener('DOMContentLoaded', function(){
            var openBtn = document.getElementById('openBankDetailsBtn');
            if(openBtn) openBtn.addEventListener('click', function(e){ e.preventDefault(); openBankModal(); });

            // Auto-save bank detail fields as the user types or changes selections
            [
                { id: 'bankSelect', key: 'checkoutBank' },
                { id: 'acctTypeSelect', key: 'checkoutBankAcctType' },
                { id: 'acctNameInput', key: 'checkoutBankAcctName' },
                { id: 'acctNumberInput', key: 'checkoutBankAcctNumber' },
                { id: 'bankNote', key: 'checkoutBankNote' }
            ].forEach(function(mapping){
                try{
                    var el = document.getElementById(mapping.id);
                    if(!el) return;
                    // save on change
                    el.addEventListener('change', function(){ try{ localStorage.setItem(mapping.key, this.value || ''); var bankEl = document.getElementById('paymentMethodBank'); if(bankEl){ var b = localStorage.getItem('checkoutBank')||''; var at = localStorage.getItem('checkoutBankAcctType')||''; if(b){ bankEl.style.display='block'; bankEl.textContent = 'Bank: ' + b + (at ? ' ('+at+')' : ''); } } }catch(e){} });
                    // also save on input for immediate persistence and enforce constraints for certain fields
                    if(mapping.id === 'acctNumberInput'){
                        el.addEventListener('input', function(){ try{ this.value = this.value.replace(/\D/g,'').slice(0,12); localStorage.setItem(mapping.key, this.value || ''); }catch(e){} });
                    } else if(mapping.id === 'acctNameInput'){
                        el.addEventListener('input', function(){ try{ if(this.value && this.value.length > 30) this.value = this.value.slice(0,30); localStorage.setItem(mapping.key, this.value || ''); }catch(e){} });
                    } else if(mapping.id === 'bankNote'){
                        el.addEventListener('input', function(){ try{ if(this.value && this.value.length > 60) this.value = this.value.slice(0,60); localStorage.setItem(mapping.key, this.value || ''); }catch(e){} });
                    } else {
                        // for selects etc. keep change handler only
                    }
                }catch(err){}
            });

            // Upload proof of payment behavior
            var uploadBtn = document.getElementById('uploadProofBtn');
            var uploadInput = document.getElementById('uploadProofInput');
            var uploadPreview = document.getElementById('uploadPreview');
            var uploadThumb = document.getElementById('uploadPreviewThumb');
            var uploadName = document.getElementById('uploadPreviewName');
            var removeBtn = document.getElementById('removeProofBtn');

            if(uploadBtn && uploadInput){
                uploadBtn.addEventListener('click', function(e){ e.preventDefault(); uploadInput.click(); });
            }

            // attach download button handler for payment QR (if present)
            try{ var dl = document.getElementById('downloadPaymentQRBtn'); if(dl) dl.addEventListener('click', function(e){ e.preventDefault(); downloadPaymentQR(); }); }catch(e){}
            if(uploadInput){
                uploadInput.addEventListener('change', function(e){
                    var f = (uploadInput.files && uploadInput.files[0]) ? uploadInput.files[0] : null;
                    if(!f) return;
                    var reader = new FileReader();
                    reader.onload = function(ev){
                        try{
                            var data = ev.target.result;
                            localStorage.setItem('checkoutProof', data);
                            localStorage.setItem('checkoutProofName', f.name);
                            // show preview
                            if(f.type && f.type.indexOf('image/') === 0){
                                uploadThumb.innerHTML = '<img src="'+data+'" style="width:100%;height:100%;object-fit:cover;">';
                            } else {
                                uploadThumb.innerHTML = '<div style="font-size:0.9rem;padding:6px;color:#666;">'+(f.type==='application/pdf' ? 'PDF' : 'FILE')+'</div>';
                            }
                            uploadName.textContent = f.name;
                            if(uploadPreview) uploadPreview.style.display = 'flex';
                            if(uploadBtn) uploadBtn.textContent = 'Change proof';
                        }catch(err){}
                    };
                    reader.readAsDataURL(f);
                });
            }
            if(removeBtn){
                removeBtn.addEventListener('click', function(e){ e.preventDefault(); localStorage.removeItem('checkoutProof'); localStorage.removeItem('checkoutProofName'); if(uploadPreview) uploadPreview.style.display='none'; if(uploadThumb) uploadThumb.innerHTML=''; if(uploadBtn) uploadBtn.textContent = '+ Upload Proof of Payment'; if(uploadInput) uploadInput.value = ''; });
            }

            // If there's an existing uploaded proof in localStorage, show it
            try{
                var existing = localStorage.getItem('checkoutProof');
                var existingName = localStorage.getItem('checkoutProofName');
                if(existing && existingName){
                    if(uploadThumb && existing.indexOf('data:image') === 0){ uploadThumb.innerHTML = '<img src="'+existing+'" style="width:100%;height:100%;object-fit:cover;">'; }
                    else if(uploadThumb){ uploadThumb.innerHTML = '<div style="font-size:0.9rem;padding:6px;color:#666;">FILE</div>'; }
                    if(uploadName) uploadName.textContent = existingName;
                    if(uploadPreview) uploadPreview.style.display = 'flex';
                    if(uploadBtn) uploadBtn.textContent = 'Change proof';
                }
            }catch(e){}
        });
        </script>
</html>
